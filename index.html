<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FreeFlow ‚Äî zam√≥w g≈Çosem</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --fg:#e9eef6; --muted:#a8b3c7; --brand:#ff7a00;
    --glass-bg: rgba(0,0,0,.36); --glass-bd: rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);
    background:#0b0f14 url("assets/Background.png") center/cover fixed no-repeat;
  }
  .hdr{display:flex;gap:12px;align-items:center;padding:16px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))}
  .brand{font-size:28px;font-weight:800}
  .brand em{color:var(--brand);font-style:normal}
  .muted{color:var(--muted);font-size:13px}
  .spacer{flex:1}
  .btn-ico{height:44px;width:44px;border-radius:14px;display:grid;place-items:center;background:var(--glass-bg);border:1px solid var(--glass-bd);backdrop-filter:blur(8px)}
  h1{margin:6px 16px 6px;font-size:34px}
  .lead{margin:0 16px 2px;color:#c9d3e3}

  /* HERO ‚Äì wiƒôksze logo, bez uciƒôƒá */
  .hero{display:grid;place-items:center;margin:4px 0 0}
  .logo-wrap{
    width:min(92vw,600px);
    max-height:52vh;                /* kontrola wysoko≈õci */
    aspect-ratio:1/1;
  }
  .logo-wrap object{width:100%;height:100%;display:block}

  /* MIC FAB */
  .mic-fab{
    position:fixed; right:18px; bottom:calc(126px + env(safe-area-inset-bottom));
    width:56px;height:56px;border-radius:50%;
    display:grid;place-items:center;font-size:24px;cursor:pointer;z-index:50;
    background:var(--glass-bg);border:1px solid var(--glass-bd);backdrop-filter:blur(10px);
  }
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  .mic-fab.on{animation:pulse 1.1s ease-in-out infinite;box-shadow:0 0 22px rgba(255,122,0,.55)}

  /* TRANSKRYPCJA wy≈ºej */
  #transcript{
    position:fixed;left:16px;right:16px;
    bottom:calc(120px + max(16px, env(safe-area-inset-bottom)));
    z-index:40;padding:14px 16px;min-height:48px;font-size:16px;
    background:var(--glass-bg);border:1px solid var(--glass-bd);border-radius:16px;backdrop-filter:blur(8px)
  }

  /* Kafelki na dole ‚Äì pojedyncze glass */
  .bottom{position:fixed;left:16px;right:16px;bottom:max(16px,env(safe-area-inset-bottom));display:flex;gap:14px;z-index:30}
  .tile{flex:1;height:72px;border-radius:18px;display:flex;align-items:center;justify-content:center;gap:10px;
    background:var(--glass-bg);border:1px solid var(--glass-bd);backdrop-filter:blur(10px);font-weight:700;color:#fff}
  .tile.active{background:rgba(20,28,38,.46);outline:2px solid rgba(64,171,255,.55)}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
  .tile.blink{animation:blink .9s linear 6}

  /* Podsumowanie */
  .summary{margin:12px 16px 120px;padding:16px;background:var(--glass-bg);border:1px solid var(--glass-bd);border-radius:16px;backdrop-filter:blur(8px)}
  .summary h2{margin:0 0 10px;font-size:18px}
  .summary ul{list-style:none;margin:0;padding:0}
  .summary li{margin:6px 0;display:flex;gap:8px;align-items:center}

  /* SVG efekty (opcjonalne ID w logo) */
  .svg-glow{filter:drop-shadow(0 0 10px rgba(255,122,0,.8)) drop-shadow(0 0 20px rgba(255,122,0,.6))}
  .svg-blink{animation:blink .9s linear infinite}
</style>
</head>
<body>
  <header class="hdr">
    <div>
      <div class="brand"><em>Free</em> Flow</div>
      <div class="muted">Voice to order ‚Äî tryb testowy, bez profilowania</div>
    </div>
    <div class="spacer"></div>
    <div class="btn-ico" aria-label="Menu">‚â°</div>
    <div class="btn-ico" aria-label="Koszyk">üõí</div>
  </header>

  <main>
    <h1>Z≈Ç√≥≈º zam√≥wienie</h1>
    <p class="lead">Jedzenie, Taxi albo nocleg ‚Äî powiedz lub kliknij.</p>

    <section class="hero">
      <div class="logo-wrap">
        <!-- je≈õli w SVG dodasz id="mic", id="icon-food", id="icon-taxi", id="icon-hotel" ‚Äì skrypt je pod≈õwietli -->
        <object id="ffLogo" type="image/svg+xml" data="assets/freeflow-logo.svg" aria-label="FreeFlow logo"></object>
      </div>
    </section>
  </main>

  <!-- P≈ÇywajƒÖcy mikrofon -->
  <button id="micFab" class="mic-fab" aria-label="Nagraj">üéôÔ∏è</button>

  <div id="transcript">S≈Çucham‚Ä¶</div>

  <section id="summaryBox" class="summary" style="display:none;">
    <h2>Podsumowanie</h2>
    <ul id="summaryList"></ul>
  </section>

  <nav class="bottom">
    <button id="btn-food"  class="tile">üçΩÔ∏è Jedzenie</button>
    <button id="btn-taxi"  class="tile">üöï Taxi</button>
    <button id="btn-hotel" class="tile">üè° Hotel</button>
  </nav>

<script>
/* ---------- UI refs ---------- */
const $t = document.getElementById('transcript');
const $sumBox = document.getElementById('summaryBox');
const $sumList = document.getElementById('summaryList');
const micFab = document.getElementById('micFab');
const tiles = {
  food:  document.getElementById('btn-food'),
  taxi:  document.getElementById('btn-taxi'),
  hotel: document.getElementById('btn-hotel'),
};

/* ---------- SVG access ---------- */
let svgDoc=null, svgMic=null, svgFood=null, svgTaxi=null, svgHotel=null;
const logoObj = document.getElementById('ffLogo');
logoObj.addEventListener('load', () => {
  svgDoc = logoObj.contentDocument;
  if(!svgDoc) return;
  svgMic   = svgDoc.getElementById('mic');
  svgFood  = svgDoc.getElementById('icon-food');
  svgTaxi  = svgDoc.getElementById('icon-taxi');
  svgHotel = svgDoc.getElementById('icon-hotel');
});

/* ---------- STT ---------- */
let recognition=null, isListening=false;
function sttSupported(){ return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window); }
function initSTT(){
  if(recognition) return;
  const Ctor = window.webkitSpeechRecognition || window.SpeechRecognition;
  if(!Ctor){ return; }
  recognition = new Ctor();
  recognition.lang='pl-PL'; recognition.continuous=true; recognition.interimResults=true;

  let finalText='';
  recognition.onstart=()=>{
    isListening=true; micFab.classList.add('on'); addMicGlow(true); setTranscript('S≈Çucham‚Ä¶'); finalText='';
  };
  recognition.onresult=(e)=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal) finalText += r[0].transcript+' ';
      else interim += r[0].transcript;
    }
    const text = cleanTranscript((finalText+interim).trim());
    setTranscript(text);
  };
  recognition.onerror=()=>{ stopSTT(); };
  recognition.onend=()=>{ isListening=false; micFab.classList.remove('on'); addMicGlow(false); parseAndSummarize($t.textContent); };
}
function startSTT(){ if(!recognition) initSTT(); try{ recognition && recognition.start(); }catch(_){} }
function stopSTT(){ try{ recognition && recognition.stop(); }catch(_){} }
function toggleSTT(){ isListening ? stopSTT() : startSTT(); }
function setTranscript(s){ $t.textContent=s; }
function cleanTranscript(s){
  return s
    .replace(/\s+/g,' ')
    .replace(/\b(\w{2,})(?:\s+\1){1,}\b/gi,'$1'); // usu≈Ñ powt√≥rzenia s≈Ç√≥w
}

/* klik w logo i w FAB */
logoObj.addEventListener('click', toggleSTT);
micFab.addEventListener('click', toggleSTT);

/* ---------- Intent parser ---------- */
const catLex = {
  taxi:  ['taxi','taks√≥w','przejazd','dojazd','kurs'],
  hotel: ['hotel','nocleg','pok√≥j','rezerw']
};
const places = ['Katowice','Krak√≥w','Krakow','Warszawa','Warszawy','Gdynia','Gda≈Ñsk','Pozna≈Ñ','Wroc≈Çaw','Sopot']; // demo
const foodHints = ['pizza','pierogi','burger','sushi','makaron','sa≈Çat','zupa','kebab','ramen'];

function detectCategory(text){
  const t=text.toLowerCase();
  if(catLex.taxi.some(w=>t.includes(w)))  return 'taxi';
  if(catLex.hotel.some(w=>t.includes(w))) return 'hotel';
  return 'food';
}
function extractTime(text){
  const m = text.match(/(?:na|o)\s+(\d{1,2})(?::(\d{2}))?/i);
  if(!m) return null;
  const hh = m[1].padStart(2,'0'); const mm = m[2]||'00';
  return `${hh}:${mm}`;
}
function extractPlace(text){
  // 1) s≈Çownik ‚Äì zwr√≥ƒá pe≈Çne dopasowanie (bez obcinania ko≈Ñc√≥wki)
  for(const p of places){
    const re = new RegExp(p,'i'); const m = text.match(re);
    if(m) return m[0];
  }
  // 2) fallback po przyimkach, ca≈Çe wyra≈ºenie z wielkich liter
  const m = text.match(/\b(?:do|na|w)\s+([A-Z≈Å≈ö≈ª≈πƒÜ√ì][\p{L}\-]+(?:\s+[A-Z≈Å≈ö≈ª≈πƒÜ√ì][\p{L}\-]+)*)/u);
  return m? m[1] : null;
}
function extractFood(text){
  const t=text.toLowerCase();
  for(const f of foodHints) if(t.includes(f)) return f;
  const stop = ['na','do','w','o','i','oraz','dla','poproszƒô','proszƒô'];
  const words = t.split(/\s+/).filter(w=>!stop.includes(w) && w.length>2);
  return words.slice(0,3).join(' ') || null;
}

function parseAndSummarize(text){
  if(!text || text.length<2) return;
  const cat = detectCategory(text);
  const time = extractTime(text);
  const place = extractPlace(text);
  const dish = (cat==='food')? extractFood(text) : null;

  blinkTile(cat);
  svgBlinkCategory(cat);

  const items=[];
  items.push({icon:'‚úÖ',text:'Status: gotowe'});
  if(cat==='food'){
    items.push({icon:'üçΩÔ∏è',text:`Danie: ${dish||'‚Äî'}`});
    if(time)  items.push({icon:'‚è±',text:`Czas: ${time}`});
    if(place) items.push({icon:'üìç',text:`Miejsce: ${place}`});
    items.push({icon:'üí≤',text:'Cena: demo'});
  }else if(cat==='taxi'){
    if(place) items.push({icon:'üìç',text:`Kierunek: ${place}`});
    if(time)  items.push({icon:'‚è±',text:`Godzina: ${time}`});
    items.push({icon:'üöï',text:'Taxi zam√≥wione (demo)'});
  }else{
    if(place) items.push({icon:'üìç',text:`Miasto: ${place}`});
    if(time)  items.push({icon:'‚è±',text:`Godzina: ${time}`});
    items.push({icon:'üè®',text:'Hotel ‚Äì rezerwacja demo'});
  }
  showSummary(items);
}

/* ---------- summary + TTS ---------- */
function showSummary(items){
  $sumList.innerHTML='';
  items.forEach(i=>{ const li=document.createElement('li'); li.innerHTML=`${i.icon} ${i.text}`; $sumList.appendChild(li); });
  $sumBox.style.display='block';
  speak('Podsumowanie. ' + items.map(i=>i.text).join('. ') + '.');
}
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text); u.lang='pl-PL';
    const use=()=>{ const v=speechSynthesis.getVoices().find(v=>v.lang?.toLowerCase().startsWith('pl')); if(v) u.voice=v; speechSynthesis.speak(u); };
    if(speechSynthesis.getVoices().length) use(); else speechSynthesis.onvoiceschanged=use;
  }catch(e){}
}

/* ---------- UI helpers ---------- */
function blinkTile(cat){
  Object.values(tiles).forEach(el=>el.classList.remove('blink','active'));
  const el = tiles[cat]; if(!el) return;
  el.classList.add('active','blink');
  setTimeout(()=>el.classList.remove('blink'), 5000);
}
function addMicGlow(on){
  if(svgMic){
    if(on){ svgMic.classList.add('svg-glow'); }
    else  { svgMic.classList.remove('svg-glow'); }
  }
}
function svgBlinkCategory(cat){
  const map={food:svgFood,taxi:svgTaxi,hotel:svgHotel};
  const node = map[cat]; if(!node) return;
  node.classList.add('svg-blink');
  setTimeout(()=>node.classList.remove('svg-blink'), 3000);
}

/* init */
if(!sttSupported()){
  // przy braku wsparcia ‚Äì przycisk nadal dzia≈Ça wizualnie, ale nie startuje STT
  micFab.title='Rozpoznawanie mowy niewspierane w tej przeglƒÖdarce';
}
</script>
</body>
</html>
