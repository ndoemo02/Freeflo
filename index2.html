<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FreeFlow ‚Äî voice + serwerowa transkrypcja</title>
<style>
:root{
  --txt:#f1f1f1; --muted:#cfd3dc; --accent:#00e5ff; --accent2:#ffb300;
  --bg-url: url("https://raw.githubusercontent.com/ndoemo02/Freeflo/main/Background.png");
  --logo-url: url("https://raw.githubusercontent.com/ndoemo02/Freeflo/main/Freeflow-logo.png");
  --transcriptOffset: 64px; /* wiƒôkszy odstƒôp od do≈Çu logo */
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{ margin:0; color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden; }

/* T≈ÅO */
.bg{ position:fixed; inset:0; z-index:0; background-image:var(--bg-url); background-size:cover; background-position:center; }
.bg::before{ content:""; position:absolute; inset:0;
  background: radial-gradient(1200px 800px at 50% 20%, rgba(10,10,16,.22), rgba(10,10,16,.40)),
              linear-gradient(180deg, rgba(10,10,16,.08), rgba(10,10,16,.26)); }
.bg::after{ content:""; position:absolute; inset:0; opacity:.02; pointer-events:none;
  background-image: radial-gradient(currentColor 1px, transparent 1px); background-size:3px 3px; }

/* Topbar */
.topbar{ position:fixed; inset:0 0 auto 0; height:56px; z-index:3000;
  display:flex; align-items:center; justify-content:space-between; padding:0 12px;
  background:linear-gradient(180deg, rgba(6,8,12,.88), rgba(6,8,12,.42)); border-bottom:1px solid rgba(255,255,255,.06); }
.brand{ font-weight:800; text-transform:uppercase; letter-spacing:.12em; }
.top-actions{ display:flex; gap:8px; }
.icon-btn{ height:36px; min-width:40px; padding:0 10px; border:1px solid rgba(255,255,255,.18);
  border-radius:12px; background:rgba(255,255,255,.06); color:var(--txt); font-size:18px; cursor:pointer; }
.icon-btn:active{ transform:translateY(1px) }
.badge{ font-size:12px; background:var(--accent2); color:#1a1a1a; padding:1px 6px; border-radius:999px; margin-left:4px; }

/* MENU: ‚ÄûP≈Çatno≈õci‚Äù ‚Üí podmenu */
.dropdown{ position:fixed; top:60px; right:10px; z-index:2600; display:none; gap:10px;
  background:rgba(16,18,28,.9); padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 30px rgba(0,0,0,.35); }
.dropdown.open{ display:block; }
.menu-item{ display:flex; align-items:center; justify-content:space-between; gap:10px;
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; cursor:pointer; }
.chev{ opacity:.8; }
.submenu{ display:none; margin-top:8px; }
.submenu.open{ display:flex; flex-direction:column; gap:8px; }
.submenu button{ background:rgba(255,255,255,.06); color:var(--txt); border:1px solid rgba(255,255,255,.12);
  border-radius:10px; padding:10px 12px; text-align:left; cursor:pointer; }
.submenu button:hover{ background:rgba(255,255,255,.12) }

/* Baner autoplay */
.toast{ position:fixed; left:50%; transform:translateX(-50%); top:64px; z-index:2700;
  background:rgba(20,24,36,.92); color:var(--txt); border:1px solid rgba(255,255,255,.12);
  padding:10px 14px; border-radius:12px; font-size:14px; display:none; }
.toast.show{ display:block }

/* KROPLA */
.logo-zone{ position:fixed; top:72px; left:50%; transform:translateX(-50%);
  width:min(76vw,380px); aspect-ratio:2/3; z-index:2000; filter: drop-shadow(0 10px 20px rgba(0,0,0,.6));
  cursor:pointer; }
.logo-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
  mix-blend-mode:screen; filter:saturate(1.08) contrast(1.06); transition:filter .25s ease, transform .25s ease; }
.recording .logo-img{ filter:saturate(1.2) contrast(1.14) brightness(1.08); transform:scale(1.01); }
@keyframes recordPulse{ 0%,100%{ transform:translateX(-50%) scale(1)} 50%{ transform:translateX(-50%) scale(1.012)} }
.recording .logo-zone{ animation:recordPulse 1.8s ease-in-out infinite; }

/* dodatkowe pulsowanie na obrazku ‚Äî pewny efekt podczas nagrywania */
@keyframes imgPulse {
  0%,100% { filter: saturate(1.20) contrast(1.14) brightness(1.08); transform: scale(1.01); }
  50%     { filter: saturate(1.28) contrast(1.18) brightness(1.12); transform: scale(1.02); }
}
.recording .logo-img{ animation: imgPulse 1.6s ease-in-out infinite; }

.droplet{ position:absolute; inset:0; -webkit-mask-image:var(--logo-url); mask-image:var(--logo-url);
  -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat; -webkit-mask-position:center; mask-position:center;
  -webkit-mask-size:contain; mask-size:contain; background:transparent; border:0; }
.wave, .wave::before, .wave::after{ content:""; position:absolute; inset:0; pointer-events:none;
  -webkit-mask-image:var(--logo-url); mask-image:var(--logo-url); -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
  -webkit-mask-position:center; mask-position:center; -webkit-mask-size:contain; mask-size:contain; }
.wave{ opacity:0; transition:opacity .25s ease; }
.wave::before{ box-shadow:0 0 18px rgba(0,229,255,.25), inset 0 0 12px rgba(0,229,255,.16); transform:scale(1.012);
  animation:breathe 2.4s ease-in-out infinite; }
.wave::after{ box-shadow:0 0 26px rgba(0,229,255,.42), inset 0 0 20px rgba(0,229,255,.24); transform:scale(1.035);
  animation:spin 7s linear infinite; }
.recording .wave{ opacity:1 }
.clicked .logo-zone{ animation:pulse 500ms ease-out }
@keyframes pulse{ 0%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.06)}100%{transform:translateX(-50%) scale(1)} }
@keyframes spin{ to{ transform:rotate(360deg) } }
@keyframes breathe{ 0%,100%{ transform:scale(1.01)} 50%{ transform:scale(1.035)} }

/* TRANSKRYPCJA ‚Äî pod logo (ni≈ºej) */
.transcript{
  position:fixed; left:50%; transform:translateX(-50%);
  top: calc(72px + min(76vw,380px) + var(--transcriptOffset));
  width:min(94vw, 560px); max-height:18vh; overflow:auto;
  background: rgba(0,0,0,.32); border:1px solid rgba(255,255,255,.14);
  border-radius:12px; padding:8px 10px; z-index:2100;
}
.line{ display:flex; gap:8px; margin:4px 0; align-items:flex-start; }
.role{ opacity:.72; min-width:84px; font-weight:700; font-size:13px; color:var(--muted); }
.text{ flex:1; font-size:14px; line-height:1.35 }

/* D√≥≈Ç */
.bottom-bar{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; z-index:2200;
  display:flex; gap:10px; padding:6px; background:rgba(10,10,16,.35); border:1px solid rgba(255,255,255,.12); border-radius:16px; }
.pill{ display:flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.14);
  border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer; background:rgba(255,255,255,.08); color:#fff; }
.pill .ico{ font-size:18px; opacity:.95 } .pill:active{ transform:translateY(1px) }
@media (max-width:400px){ .logo-zone{width:78vw} .transcript{width:94vw} .pill{padding:10px 12px; font-size:15px} }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <header class="topbar">
    <div class="brand">FREEFLOW</div>
    <nav class="top-actions">
      <button class="icon-btn" aria-label="Menu" onclick="toggleMenu()">‚ò∞</button>
      <button class="icon-btn" aria-label="Koszyk" onclick="openCart()">üõí <span class="badge" id="cartCount">0</span></button>
    </nav>
  </header>

  <!-- MENU -->
  <div class="dropdown" id="mainMenu">
    <div class="menu-item" onclick="togglePayments()"><span>üí≥ P≈Çatno≈õci</span><span class="chev" id="payChev">‚ñæ</span></div>
    <div class="submenu" id="paymentsSub">
      <button onclick="selectPay('BLIK')">BLIK</button>
      <button onclick="selectPay('Karta')">Karta</button>
      <button onclick="selectPay('PayPal')">PayPal</button>
    </div>
    <div class="menu-item" onclick="openOrders()">üì¶ Moje zam√≥wienia</div>
    <div class="menu-item" onclick="openHelp()">‚ùì Pomoc / FAQ</div>
  </div>

  <!-- AUTOPLAY BANER -->
  <div id="audioToast" class="toast">üîä Stuknij, aby odtworzyƒá komunikat</div>

  <!-- KROPLA (uwaga: BEZ onclick w HTML) -->
  <div class="logo-zone" id="logoZone" role="button" tabindex="0">
    <img class="logo-img" src="https://raw.githubusercontent.com/ndoemo02/Freeflo/main/Freeflow-logo.png" alt="FreeFlow logo">
    <div class="droplet" id="logoHit"></div>
    <div class="wave"></div>
  </div>

  <!-- TRANSKRYPCJA -->
  <div class="transcript" id="transcriptBox" aria-live="polite"></div>

  <!-- D√ì≈Å -->
  <div class="bottom-bar">
    <button class="pill" onclick="quickIntent('Jedzenie')"><span class="ico">üçΩÔ∏è</span><span>Jedzenie</span></button>
    <button class="pill" onclick="quickIntent('Taxi')"><span class="ico">üöï</span><span>Taxi</span></button>
    <button class="pill" onclick="quickIntent('Hotel')"><span class="ico">üè®</span><span>Hotel</span></button>
  </div>

<script>
/* ============================ KONFIG ============================ */
let cart = 0, recording = false, introSpoken = false;
const ASR_URL = 'https://freeflow-backend-vercel.vercel.app/api/asr';
const CHUNK_MS = 4000;

/* ============================ UI ============================ */
function toggleMenu(){ document.getElementById('mainMenu').classList.toggle('open'); }
function togglePayments(){
  const sub = document.getElementById('paymentsSub'); const chev = document.getElementById('payChev');
  sub.classList.toggle('open'); chev.textContent = sub.classList.contains('open') ? '‚ñ¥' : '‚ñæ';
}
function openCart(){ alert('Koszyk (demo).'); }
function openOrders(){ alert('Moje zam√≥wienia (demo).'); }
function openHelp(){ alert('Pomoc / FAQ (demo).'); }
function selectPay(type){ appendTranscript('asst', `Wybrano metodƒô p≈Çatno≈õci: ${type}.`); }

function appendTranscript(role, text){
  const box = document.getElementById('transcriptBox');
  const line = document.createElement('div'); line.className='line';
  const r = document.createElement('div'); r.className='role'; r.textContent = role==='user'?'Ty:':'Asystent:';
  const t = document.createElement('div'); t.className='text'; t.textContent = text;
  line.append(r,t); box.append(line); box.scrollTop = box.scrollHeight;
}
function quickIntent(kind){
  cart++; document.getElementById('cartCount').textContent = cart;
  appendTranscript('user', `Wybieram: ${kind}.`);
  speakAndLog(`Potwierdzam wyb√≥r: ${kind}. Dodano do koszyka.`);
}

/* ============================ VOICE ============================ */
let recognizer = null;     // Web Speech API (fallback)
let mr = null, stream = null, mime = null; // MediaRecorder (server ASR)

const hasSR = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
function initRecognizer(){
  const Ctor = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new Ctor();
  rec.lang = 'pl-PL'; rec.interimResults = true; rec.continuous = true;
  rec.onresult = (e)=>{
    let finalChunk = '';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const chunk = e.results[i][0].transcript.trim();
      if(e.results[i].isFinal){ finalChunk += (finalChunk?' ':'') + chunk; }
    }
    if(finalChunk){ appendTranscript('user', finalChunk); }
  };
  rec.onerror = (e)=>console.warn('SR error:', e.error);
  rec.onend = ()=>{ if(recording){ try{ rec.start(); }catch(_){} } };
  return rec;
}

async function startServerASR(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
  }catch(err){
    appendTranscript('asst','Brak dostƒôpu do mikrofonu.');
    throw err;
  }
  if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime = 'audio/webm;codecs=opus';
  else if(MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) mime = 'audio/ogg;codecs=opus';
  else if(MediaRecorder.isTypeSupported('audio/webm')) mime = 'audio/webm';
  else { appendTranscript('asst','MediaRecorder nieobs≈Çugiwany ‚Äì wracam do rozpoznawania przeglƒÖdarkowego.'); throw new Error('no-mime'); }

  mr = new MediaRecorder(stream, {mimeType: mime});
  mr.ondataavailable = async (e)=>{
    if(!e.data || e.data.size === 0) return;
    try{
      const fd = new FormData();
      fd.append('audio', e.data, `chunk.${mime.includes('ogg')?'ogg':'webm'}`);

      const res = await fetch(ASR_URL, { method:'POST', body: fd });

      let text = '';
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const json = await res.json();
        text = (json && (json.text || json.transcript || '')).trim();
      } else {
        text = (await res.text()).trim();
      }

      if(text) appendTranscript('user', text);
    }catch(err){
      console.warn('ASR send error:', err);
    }
  };
  mr.start(CHUNK_MS);
}

function stopServerASR(){
  try{ if(mr && mr.state !== 'inactive') mr.stop(); }catch(_){}
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  mr = null; stream = null; mime = null;
}

async function startRecording(){
  try{
    await startServerASR();
    appendTranscript('asst','Transkrypcja serwerowa aktywna.');
    return;
  }catch(err){
    console.warn('Server ASR unavailable, falling back to SR:', err);
  }
  if(!hasSR){
    appendTranscript('asst','Twoja przeglƒÖdarka nie obs≈Çuguje rozpoznawania mowy. Dostƒôpny jest tylko TTS.');
    return;
  }
  if(!recognizer) recognizer = initRecognizer();
  try{ recognizer.start(); appendTranscript('asst','Transkrypcja przeglƒÖdarkowa aktywna.'); }catch(_){}
}
function stopRecording(){
  try{ if(recognizer) recognizer.stop(); }catch(_){}
  stopServerASR();
}

/* Debounce klik√≥w (touchstart + click na mobile) */
let lastToggleTs = 0;
function safeToggle(){
  const now = Date.now();
  if (now - lastToggleTs < 400) return; // ignoruj zdublowane eventy z jednego dotkniƒôcia
  lastToggleTs = now;
  toggleVoice();
}

function toggleVoice(){
  const wasRecording = recording;
  appendTranscript('asst', `Prze≈ÇƒÖczanie nagrywania: ${wasRecording ? 'ON‚ÜíOFF' : 'OFF‚ÜíON'}`);

  if(!introSpoken){ sayIntro(); }
  recording = !recording;
  document.body.classList.toggle('recording', recording);
  document.body.classList.add('clicked'); setTimeout(()=>document.body.classList.remove('clicked'), 500);

  if(recording){
    appendTranscript('asst','Nagrywanie w≈ÇƒÖczone. S≈Çucham.');
    speak('Nagrywanie w≈ÇƒÖczone. S≈Çucham.');
    startRecording();
  }else{
    appendTranscript('asst','Nagrywanie wy≈ÇƒÖczone.');
    speak('Nagrywanie wy≈ÇƒÖczone.');
    stopRecording();
  }
}

/* --- Pewne podpiƒôcie klik√≥w do logo (bez onclick w HTML) --- */
(function ensureLogoClicks(){
  const zone = document.getElementById('logoZone');
  const hit  = document.getElementById('logoHit');

  function onToggle(e){
    e.preventDefault(); e.stopPropagation();
    appendTranscript('asst', 'Klik na logo wykryty.');
    safeToggle();
  }
  ['touchstart','click'].forEach(ev => {
    zone.addEventListener(ev, onToggle, {passive:true});
    if (hit) hit.addEventListener(ev, onToggle, {passive:true});
  });
  zone.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') { onToggle(e); }
  });
})();

/* ============================ TTS ============================ */
function speakAndLog(text){ appendTranscript('asst', text); speak(text); }
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pl-PL';
    const vs = speechSynthesis.getVoices();
    const prefer = vs.find(v=>v.lang.startsWith('pl') && /female|Zosia|Paulina|Agata|Agnieszka|Ewa|Maja/i.test(v.name));
    const anyPL = vs.find(v=>v.lang.startsWith('pl'));
    u.voice = prefer || anyPL || null;
    u.rate = 1; u.pitch = 1; u.volume = 1;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch(e){ console.warn('TTS error:', e); }
}

/* ============================ INTRO ============================ */
const introText = 'W celu z≈Ço≈ºenia zam√≥wienia proszƒô nacisnƒÖƒá logo. Po aktywacji trybu voice dopytam o szczeg√≥≈Çy.';
function sayIntro(){ if(introSpoken) return; introSpoken = true; hideToast(); speakAndLog(introText); }
function showToast(){ document.getElementById('audioToast').classList.add('show'); }
function hideToast(){ document.getElementById('audioToast').classList.remove('show'); }
function attachUnlockOnce(){
  const unlock = ()=>{ sayIntro();
    window.removeEventListener('pointerdown', unlock, {passive:true});
    window.removeEventListener('touchstart', unlock, {passive:true});
    window.removeEventListener('click', unlock, {passive:true});
  };
  window.addEventListener('pointerdown', unlock, {passive:true});
  window.addEventListener('touchstart', unlock, {passive:true});
  window.addEventListener('click', unlock, {passive:true});
}
function tryAutoplay(){
  speakAndLog(introText);
  setTimeout(()=>{
    if(!speechSynthesis.speaking){ showToast(); attachUnlockOnce(); }
    else { introSpoken = true; hideToast(); }
  }, 700);
}
if(typeof speechSynthesis!=='undefined'){ speechSynthesis.onvoiceschanged=()=>{}; }
window.addEventListener('load', tryAutoplay, {once:true});
</script>
</body>
</html>
