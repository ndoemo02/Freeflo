<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>FreeFlow ‚Äî Voice to order</title>
<meta name="theme-color" content="#0b0f13" />
<style>
  :root{
    --bg:#0b0f13; --bg2:#11161c; --fg:#e9eef5; --muted:#9aa7b6;
    --brand:#ff7a1a; --brand-2:#ffad66; --ok:#45d483; --err:#ff4d5a;
    --card:#0f141a; --ring:#1f2732; --shadow: 0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--fg); background:
      radial-gradient(1200px 600px at 50% -200px, #1a2230 0%, transparent 70%),
      var(--bg);
  }
  .wrap{max-width:980px;margin:0 auto;padding:20px 16px 56px}
  header{display:flex;align-items:center;gap:14px}
  .logo-text{font-weight:800;font-size:32px;letter-spacing:.5px}
  .logo-text .free{color:var(--brand)} .logo-text .flow{color:#f1f5f9}
  .sub{color:var(--muted);font-size:14px;margin-left:6px}
  .actions{margin-left:auto;display:flex;gap:10px}
  .icon-btn{
    width:44px;height:44px;border-radius:12px;background:#141a21;border:1px solid #232b36;
    display:grid;place-items:center;box-shadow:var(--shadow);position:relative
  }
  .badge{position:absolute;top:-8px;right:-8px;background:var(--brand);color:#111;font-weight:700;
    font-size:12px;width:22px;height:22px;display:grid;place-items:center;border-radius:50%}
  h1{font-size:48px;line-height:1.05;margin:18px 0 6px}
  .lead{margin:0 0 18px;color:#b8c3cf}
  /* MIC area */
  .mic-area{position:relative;display:grid;place-items:center;margin:10px 0 16px}
  .mic-ring{width:92vw;max-width:560px;aspect-ratio:1/1;border-radius:50%;
    background:radial-gradient(60% 60% at 50% 40%, rgba(255,122,26,.16), transparent 70%),
               radial-gradient(35% 35% at 50% 50%, rgba(255,173,102,.08), transparent 75%),
               #070a0d;border:1px dashed #2a3442;display:grid;place-items:center}
  .mic-wrap{position:relative;width:88%;aspect-ratio:1/1;border-radius:50%;
    display:grid;place-items:center;cursor:pointer;user-select:none;touch-action:manipulation;
    transition:transform .18s ease, filter .2s ease}
  .mic-wrap:hover{transform:scale(.995)}
  .mic-wrap.active{animation:pulse 1.6s ease-in-out infinite;filter:drop-shadow(0 0 22px rgba(255,122,26,.25))}
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,122,26,.35)}
    70%{box-shadow:0 0 0 24px rgba(255,122,26,0)}
    100%{box-shadow:0 0 0 0 rgba(255,122,26,0)}
  }
  .mic-wrap img{width:100%;height:100%;object-fit:contain;border-radius:50%}
  .status-pill{
    position:absolute;bottom:10%;left:50%;transform:translateX(-50%);
    background:rgba(19,24,30,.88);border:1px solid #253041;color:#e7edf5;
    padding:10px 14px;border-radius:16px;backdrop-filter:blur(6px);display:flex;gap:10px;align-items:center
  }
  .dot{width:10px;height:10px;border-radius:50%;background:var(--err);box-shadow:0 0 0 2px rgba(0,0,0,.35) inset}
  .dot.ok{background:var(--ok)}
  /* transcript */
  .trans-wrap{margin-top:14px}
  .trans{
    background:#0f141a;border:1px solid #243042;border-radius:16px;padding:16px 18px;
    font-size:18px;min-height:56px;display:flex;align-items:center;gap:10px
  }
  .ghost{color:#6f8094}
  /* quick chips */
  .chips{display:flex;gap:14px;flex-wrap:wrap;margin-top:16px}
  .chip{
    background:#121922;border:1px solid #243042;border-radius:16px;padding:12px 16px;
    display:flex;align-items:center;gap:10px;box-shadow:var(--shadow)
  }
  /* Dev panel */
  .kebab{position:fixed;top:16px;right:82px;z-index:50}
  .dev{
    position:fixed;right:12px;top:68px;width:88vw;max-width:520px;max-height:55vh;overflow:auto;
    padding:12px;border-radius:14px;background:#0c1117;border:1px solid #223044;display:none;z-index:60
  }
  .dev pre{white-space:pre-wrap;margin:0;font-size:12px;color:#c6d3e3}
  .dev.show{display:block}
  @media (min-width:900px){
    h1{font-size:56px}
    .mic-ring{max-width:620px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo-text"><span class="free">Free</span> <span class="flow">Flow</span></div>
      <div class="sub">Voice to order</div>
      <div class="actions">
        <button class="icon-btn kebab" id="btnDev" aria-label="Dev">‚ãÆ</button>
        <div class="icon-btn" aria-label="Koszyk">
          <span style="font-size:20px">üõí</span>
          <span class="badge" id="cartCount">0</span>
        </div>
      </div>
    </header>

    <h1>Z≈Ç√≥≈º zam√≥wienie</h1>
    <p class="lead">Taxi, posi≈Çek, a mo≈ºe nocleg?</p>

    <section class="mic-area">
      <div class="mic-ring">
        <button id="micBtn" class="mic-wrap" aria-label="Nagraj / zatrzymaj">
          <img src="Freeflow-logo.png" alt="FreeFlow ‚Äî logo mikrofonu" />
          <div id="statusPill" class="status-pill">
            <span id="statusDot" class="dot"></span>
            <span id="statusTxt">Dotknij logo i m√≥w‚Ä¶</span>
          </div>
        </button>
      </div>
    </section>

    <section class="trans-wrap">
      <div class="trans">
        <span id="recDot" class="dot"></span>
        <span id="transcript"><span class="ghost">Transkrypcja pojawi siƒô tutaj‚Ä¶</span></span>
      </div>
    </section>

    <div class="chips" aria-label="Szybkie kategorie">
      <div class="chip">üçΩÔ∏è Jedzenie</div>
      <div class="chip">üöï Taxi</div>
      <div class="chip">üè® Hotel</div>
    </div>
  </div>

  <!-- Dev panel -->
  <div id="dev" class="dev"><pre id="log"></pre></div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const log = (...a)=>{ const el=$("#log"); if(!el) return; el.textContent += a.join(" ")+"\n"; el.scrollTop = el.scrollHeight; };

  const micBtn = $("#micBtn");
  const statusTxt = $("#statusTxt");
  const statusDot = $("#statusDot");
  const recDot = $("#recDot");
  const transcriptEl = $("#transcript");
  const devBtn = $("#btnDev");
  const dev = $("#dev");

  // ---- Dev panel toggle
  devBtn.addEventListener("click", ()=> dev.classList.toggle("show"));

  // ---- Web Speech: ASR
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let listening = false;
  let autoRestart = false;

  function initRecognition(){
    if (!SpeechRec) {
      statusTxt.textContent = "Twoja przeglƒÖdarka nie wspiera rozpoznawania mowy";
      log("NO SpeechRecognition");
      return;
    }
    recognition = new SpeechRec();
    recognition.lang = "pl-PL";
    recognition.interimResults = true;
    recognition.continuous = true; // d≈Çu≈ºsze wypowiedzi
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      listening = true;
      micBtn.classList.add("active");
      statusDot.classList.add("ok");
      recDot.classList.add("ok");
      statusTxt.textContent = "S≈Çucham‚Ä¶ m√≥w ≈õmia≈Ço";
      log("[ASR] start");
    };
    recognition.onend = () => {
      micBtn.classList.remove("active");
      statusDot.classList.remove("ok");
      recDot.classList.remove("ok");
      statusTxt.textContent = "Zatrzymano. Dotknij, aby m√≥wiƒá‚Ä¶";
      listening = false;
      log("[ASR] end");
      if (autoRestart) {
        setTimeout(()=>{ try{ recognition.start(); }catch(e){ log("restart error:", e.message); } }, 120);
      }
    };
    recognition.onerror = (e) => {
      log("[ASR] error:", e.error);
      statusTxt.textContent = "B≈ÇƒÖd mikrofonu (‚Äû" + e.error + "‚Äù). Spr√≥buj ponownie.";
      // Nie wieszaj autoRestart przy odmowie uprawnie≈Ñ
      if (e.error === "not-allowed" || e.error==="service-not-allowed") autoRestart = false;
    };
    recognition.onresult = (evt) => {
      let finalTxt = "";
      let interimTxt = "";
      for (let i = evt.resultIndex; i < evt.results.length; i++){
        const res = evt.results[i];
        if (res.isFinal) finalTxt += res[0].transcript;
        else interimTxt += res[0].transcript;
      }
      const combined = (finalTxt || interimTxt).trim();
      transcriptEl.textContent = combined || "‚Ä¶";
      if (finalTxt) {
        autoRestart = false; // daj TTS doj≈õƒá do s≈Çowa
        handleCommand(finalTxt.toLowerCase());
      }
    };
    log("Recognition inited");
  }

  // ---- TTS
  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "pl-PL";
      u.rate = 1; u.pitch = 1; u.volume = 1;
      // wybierz polski g≈Ços je≈õli jest
      const v = speechSynthesis.getVoices().find(v=>/pl[-_]?PL/i.test(v.lang));
      if (v) u.voice = v;
      speechSynthesis.cancel(); // przerywaj poprzednie
      speechSynthesis.speak(u);
    }catch(e){ log("TTS error:", e.message); }
  }
  // Poprawka na op√≥≈∫nione za≈Çadowanie listy g≈Ços√≥w (Android)
  if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = ()=>{};
  }

  // ---- Prosty router zamiar√≥w (demo)
  function handleCommand(txt){
    log("[NLU] ", txt);
    let reply = "";
    if (/(pizza|pizze|pepperoni|margherita)/i.test(txt)){
      reply = "OK, dwie pizze pepperoni. Doda≈Çem do koszyka.";
      bumpCart(2);
    } else if (/(taxi|taks√≥wk|dworzec|lotnisk)/i.test(txt)){
      reply = "Zamawiam taxi na wskazany adres. O kt√≥rej ma podjechaƒá?";
    } else if (/(hotel|nocleg|pok√≥j)/i.test(txt)){
      reply = "Szukam hotelu w Twojej okolicy. Jaki standard i daty?";
    } else {
      reply = "Jasne. Powiedz, czy chodzi o jedzenie, taxi czy hotel.";
    }
    speak(reply);
    statusTxt.textContent = reply;
    autoRestart = true; // wr√≥ƒá do nas≈Çuchu po odpowiedzi
    try { recognition && recognition.start(); } catch {}
  }

  function bumpCart(n=1){
    const el = document.getElementById("cartCount");
    const v = parseInt(el.textContent || "0", 10) + n;
    el.textContent = String(v);
  }

  // ---- Start / stop na logo
  micBtn.addEventListener("click", async () => {
    if (!recognition) initRecognition();
    if (!recognition) return;

    // ≈ºƒÖdanie uprawnie≈Ñ w kontek≈õcie gestu
    if (!listening) {
      autoRestart = true;
      try{
        // Android potrafi nie rozpoczynaƒá je≈õli TTS gra ‚Äì wyczy≈õƒá
        speechSynthesis.cancel();
        recognition.start();
      }catch(e){
        log("start error:", e.message);
        statusTxt.textContent = "Nie mogƒô uruchomiƒá mikrofonu: " + e.message;
      }
    } else {
      autoRestart = false;
      try{ recognition.stop(); }catch(e){ log("stop error:", e.message); }
    }
  });

  // ---- Menu (placeholder ‚Äì loguje)
  document.addEventListener("click",(e)=>{
    const t = e.target.closest(".icon-btn");
    if (t && !t.classList.contains("kebab")) {
      log("[UI] click icon btn");
    }
  });

  // Init
  initRecognition();
})();
</script>
</body>
</html>
