<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freeflow — po prostu zamów</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-950 text-white">
  <main class="min-h-screen flex flex-col items-center">
    <!-- HERO -->
    <section class="w-full max-w-3xl px-5 pt-16 pb-6 text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">
        Freeflow <span class="opacity-80">— po prostu zamów</span>
      </h1>
      <p class="mt-3 text-neutral-300">
        Powiedz, czego potrzebujesz: „dwie pizze w Krakowie o 20:00”, „zamów taxi na 18:30”, „nocleg w Warszawie”.
      </p>
    </section>

    <!-- BOX ZAMÓWIENIA -->
    <section class="w-full max-w-3xl px-5">
      <div class="rounded-2xl bg-black/30 backdrop-blur border border-white/10 p-5">
        <div class="flex items-center gap-3">
          <button id="micBtn"
                  class="shrink-0 rounded-full p-4 bg-emerald-500/20 border border-emerald-400/30 hover:bg-emerald-500/30 transition"
                  title="Włącz mikrofon">
            🎤
          </button>
          <input id="queryInput" type="text" inputmode="text"
                 placeholder="Powiedz lub wpisz zamówienie…"
                 class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-emerald-400"/>
          <button id="sendBtn"
                  class="rounded-xl px-4 py-3 bg-emerald-500 text-black font-semibold hover:bg-emerald-400 transition">
            Wyślij
          </button>
        </div>

        <div id="hint" class="mt-3 text-sm text-neutral-400">
          Próba automatycznego włączenia mikrofonu… Jeśli prośba o uprawnienie się nie pojawi, kliknij „🎤”.
        </div>

        <div id="status" class="mt-3 text-xs text-neutral-400"></div>

        <div id="result" class="mt-5 hidden">
          <h3 class="font-semibold text-neutral-200">Wynik</h3>
          <pre id="json" class="mt-2 text-xs bg-white/5 border border-white/10 rounded-lg p-3 overflow-x-auto"></pre>
        </div>
      </div>
    </section>

    <!-- KOSZYK / POTWIERDZENIE (prosty placeholder na dziś) -->
    <section class="w-full max-w-3xl px-5 mt-6">
      <div id="confirmBox" class="hidden rounded-2xl bg-black/30 backdrop-blur border border-white/10 p-5">
        <h3 class="font-semibold text-neutral-200">Potwierdzenie</h3>
        <p id="confirmText" class="mt-2 text-neutral-300"></p>
      </div>
    </section>

    <footer class="mt-auto py-10 text-xs text-neutral-500">
      Bez profilowania. Sesja tymczasowa. © Freeflow
    </footer>
  </main>

<script>
(() => {
  // ====== KONFIG ======
  const HOST = 'https://freeflow-backend-vercel.vercel.app';
  const ENDPOINTS = {
    plan:  `${HOST}/api/plan`,
    tts:   `${HOST}/api/tts`,
    places:`${HOST}/api/places`,
  };

  // ====== STAN SESJI (bez profilowania) ======
  const sessionId = (() => {
    const k = 'ff_session';
    let v = sessionStorage.getItem(k);
    if (!v) { v = crypto.randomUUID(); sessionStorage.setItem(k, v); }
    return v;
  })();

  // ====== ELEMENTY UI ======
  const micBtn = document.getElementById('micBtn');
  const queryInput = document.getElementById('queryInput');
  const sendBtn = document.getElementById('sendBtn');
  const statusEl = document.getElementById('status');
  const resultWrap = document.getElementById('result');
  const jsonEl = document.getElementById('json');
  const hintEl = document.getElementById('hint');
  const confirmBox = document.getElementById('confirmBox');
  const confirmText = document.getElementById('confirmText');

  // ====== NARZĘDZIA ======
  const speakLocal = (text) => {
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pl-PL';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    } catch {}
  };

  const speakFromBackend = async (text) => {
    try {
      const r = await fetch(ENDPOINTS.tts, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text, lang: 'pl-PL' }),
      });
      if (!r.ok) throw new Error('TTS HTTP ' + r.status);
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      await a.play();
    } catch (e) {
      // fallback do TTS przeglądarki
      speakLocal(text);
    }
  };

  const showStatus = (msg) => { statusEl.textContent = msg || ''; };
  const showResult = (obj) => {
    resultWrap.classList.remove('hidden');
    jsonEl.textContent = JSON.stringify(obj, null, 2);
  };

  // ====== ROZPOZNAWANIE MOWY (Web Speech API) ======
  let recognizing = false;
  let recognition;

  const initRecognition = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const rec = new SR();
    rec.lang = 'pl-PL';
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    rec.onstart = () => { recognizing = true; showStatus('Słucham… powiedz zamówienie.'); micBtn.classList.add('ring-2','ring-emerald-400'); };
    rec.onend   = () => { recognizing = false; micBtn.classList.remove('ring-2','ring-emerald-400'); };
    rec.onerror = (e) => { recognizing = false; showStatus('Błąd mikrofonu: ' + (e.error || 'nieznany')); };

    rec.onresult = async (ev) => {
      const transcript = ev.results[0][0].transcript.trim();
      queryInput.value = transcript;
      showStatus(`Rozpoznano: “${transcript}”`);
      await handleQuery(transcript);
    };

    return rec;
  };

  const startMic = async () => {
    try {
      // Wymusza prompt uprawnień w części przeglądarek
      await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch {}
    try {
      if (!recognition) recognition = initRecognition();
      if (recognition && !recognizing) recognition.start();
    } catch (e) {
      showStatus('Nie mogę uruchomić rozpoznawania mowy. Kliknij „🎤”.');
    }
  };

  // ====== OBSŁUGA ZAPYTANIA ======
  async function handleQuery(text) {
    const q = (text || queryInput.value || '').trim();
    if (!q) { showStatus('Podaj treść zamówienia.'); return; }

    showStatus('Przetwarzam zamówienie…');
    confirmBox.classList.add('hidden');

    try {
      const res = await fetch(ENDPOINTS.plan, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ query: q, sessionId }),
      });
      const data = await res.json();

      if (!res.ok) {
        showStatus((data && data.error) ? `Błąd: ${data.error}` : `Błąd: HTTP ${res.status}`);
        showResult(data || {});
        return;
      }

      showResult(data);
      // proste potwierdzenie
      confirmText.textContent = `OK. Zrozumiałem: ${q}. Krok: ${data.steps?.[0]?.message || '—'}`;
      confirmBox.classList.remove('hidden');

      // mówimy do użytkownika
      await speakFromBackend('Zamówienie przyjęte. ' + (data.steps?.[0]?.message || ''));

      showStatus('Gotowe.');
    } catch (e) {
      showStatus('Błąd połączenia.');
    }
  }

  // ====== ZDARZENIA ======
  sendBtn.addEventListener('click', () => handleQuery());
  micBtn.addEventListener('click', () => startMic());
  queryInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleQuery();
  });

  // ====== START: auto-instrukcja + próba auto-mikrofonu ======
  const startup = async () => {
    const intro = 'Freeflow — po prostu zamów. Powiedz na głos swoje zamówienie.';
    // mówimy od razu (to zwykle działa bez gestu)
    speakLocal(intro);
    // spróbuj włączyć mikrofon automatycznie (może wymagać gestu – wtedy pokaż hint)
    try {
      await startMic();
      hintEl.textContent = 'Mikrofon włączony. Mów śmiało!';
    } catch {
      hintEl.textContent = 'Kliknij ikonę 🎤, aby włączyć mikrofon.';
    }

    // plan B: pierwszy dotyk w dowolnym miejscu również odpali mikrofon
    const oneTap = () => { startMic(); window.removeEventListener('pointerdown', oneTap); };
    window.addEventListener('pointerdown', oneTap, { once: true });
  };

  window.addEventListener('DOMContentLoaded', startup);
})();
</script>
</body>
</html>
