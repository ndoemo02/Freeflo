<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Freeflow â€” po prostu zamÃ³w</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-950 text-white">
  <main class="min-h-screen flex flex-col items-center">
    <!-- HERO -->
    <section class="w-full max-w-3xl px-5 pt-16 pb-6 text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">
        Freeflow <span class="opacity-80">â€” po prostu zamÃ³w</span>
      </h1>
      <p class="mt-3 text-neutral-300">
        Powiedz, czego potrzebujesz: â€dwie pizze w Krakowie o 20:00â€, â€zamÃ³w taxi na 18:30â€, â€nocleg w Warszawieâ€.
      </p>
    </section>

    <!-- BOX ZAMÃ“WIENIA -->
    <section class="w-full max-w-3xl px-5">
      <div class="rounded-2xl bg-black/30 backdrop-blur border border-white/10 p-5">
        <div class="flex items-center gap-3">
          <button id="micBtn"
                  class="shrink-0 rounded-full p-4 bg-emerald-500/20 border border-emerald-400/30 hover:bg-emerald-500/30 transition"
                  title="WÅ‚Ä…cz mikrofon">
            ğŸ¤
          </button>
          <input id="queryInput" type="text" inputmode="text"
                 placeholder="Powiedz lub wpisz zamÃ³wienieâ€¦"
                 class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-emerald-400"/>
          <button id="sendBtn"
                  class="rounded-xl px-4 py-3 bg-emerald-500 text-black font-semibold hover:bg-emerald-400 transition">
            WyÅ›lij
          </button>
        </div>

        <div id="hint" class="mt-3 text-sm text-neutral-400">
          PrÃ³ba automatycznego wÅ‚Ä…czenia mikrofonuâ€¦ JeÅ›li proÅ›ba o uprawnienie siÄ™ nie pojawi, kliknij â€ğŸ¤â€.
        </div>

        <div id="status" class="mt-3 text-xs text-neutral-400"></div>

        <div id="result" class="mt-5 hidden">
          <h3 class="font-semibold text-neutral-200">Wynik</h3>
          <pre id="json" class="mt-2 text-xs bg-white/5 border border-white/10 rounded-lg p-3 overflow-x-auto"></pre>
        </div>
      </div>
    </section>

    <!-- KOSZYK / POTWIERDZENIE (prosty placeholder na dziÅ›) -->
    <section class="w-full max-w-3xl px-5 mt-6">
      <div id="confirmBox" class="hidden rounded-2xl bg-black/30 backdrop-blur border border-white/10 p-5">
        <h3 class="font-semibold text-neutral-200">Potwierdzenie</h3>
        <p id="confirmText" class="mt-2 text-neutral-300"></p>
      </div>
    </section>

    <footer class="mt-auto py-10 text-xs text-neutral-500">
      Bez profilowania. Sesja tymczasowa. Â© Freeflow
    </footer>
  </main>

<script>
(() => {
  // ====== KONFIG ======
  const HOST = 'https://freeflow-backend-vercel.vercel.app';
  const ENDPOINTS = {
    plan:  `${HOST}/api/plan`,
    tts:   `${HOST}/api/tts`,
    places:`${HOST}/api/places`,
  };

  // ====== STAN SESJI (bez profilowania) ======
  const sessionId = (() => {
    const k = 'ff_session';
    let v = sessionStorage.getItem(k);
    if (!v) { v = crypto.randomUUID(); sessionStorage.setItem(k, v); }
    return v;
  })();

  // ====== ELEMENTY UI ======
  const micBtn = document.getElementById('micBtn');
  const queryInput = document.getElementById('queryInput');
  const sendBtn = document.getElementById('sendBtn');
  const statusEl = document.getElementById('status');
  const resultWrap = document.getElementById('result');
  const jsonEl = document.getElementById('json');
  const hintEl = document.getElementById('hint');
  const confirmBox = document.getElementById('confirmBox');
  const confirmText = document.getElementById('confirmText');

  // ====== NARZÄ˜DZIA ======
  const speakLocal = (text) => {
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pl-PL';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    } catch {}
  };

  const speakFromBackend = async (text) => {
    try {
      const r = await fetch(ENDPOINTS.tts, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text, lang: 'pl-PL' }),
      });
      if (!r.ok) throw new Error('TTS HTTP ' + r.status);
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = new Audio(url);
      await a.play();
    } catch (e) {
      // fallback do TTS przeglÄ…darki
      speakLocal(text);
    }
  };

  const showStatus = (msg) => { statusEl.textContent = msg || ''; };
  const showResult = (obj) => {
    resultWrap.classList.remove('hidden');
    jsonEl.textContent = JSON.stringify(obj, null, 2);
  };

  // ====== ROZPOZNAWANIE MOWY (Web Speech API) ======
  let recognizing = false;
  let recognition;

  const initRecognition = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const rec = new SR();
    rec.lang = 'pl-PL';
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    rec.onstart = () => { recognizing = true; showStatus('SÅ‚uchamâ€¦ powiedz zamÃ³wienie.'); micBtn.classList.add('ring-2','ring-emerald-400'); };
    rec.onend   = () => { recognizing = false; micBtn.classList.remove('ring-2','ring-emerald-400'); };
    rec.onerror = (e) => { recognizing = false; showStatus('BÅ‚Ä…d mikrofonu: ' + (e.error || 'nieznany')); };

    rec.onresult = async (ev) => {
      const transcript = ev.results[0][0].transcript.trim();
      queryInput.value = transcript;
      showStatus(`Rozpoznano: â€œ${transcript}â€`);
      await handleQuery(transcript);
    };

    return rec;
  };

  const startMic = async () => {
    try {
      // Wymusza prompt uprawnieÅ„ w czÄ™Å›ci przeglÄ…darek
      await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch {}
    try {
      if (!recognition) recognition = initRecognition();
      if (recognition && !recognizing) recognition.start();
    } catch (e) {
      showStatus('Nie mogÄ™ uruchomiÄ‡ rozpoznawania mowy. Kliknij â€ğŸ¤â€.');
    }
  };

  // ====== OBSÅUGA ZAPYTANIA ======
  async function handleQuery(text) {
    const q = (text || queryInput.value || '').trim();
    if (!q) { showStatus('Podaj treÅ›Ä‡ zamÃ³wienia.'); return; }

    showStatus('Przetwarzam zamÃ³wienieâ€¦');
    confirmBox.classList.add('hidden');

    try {
      const res = await fetch(ENDPOINTS.plan, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ query: q, sessionId }),
      });
      const data = await res.json();

      if (!res.ok) {
        showStatus((data && data.error) ? `BÅ‚Ä…d: ${data.error}` : `BÅ‚Ä…d: HTTP ${res.status}`);
        showResult(data || {});
        return;
      }

      showResult(data);
      // proste potwierdzenie
      confirmText.textContent = `OK. ZrozumiaÅ‚em: ${q}. Krok: ${data.steps?.[0]?.message || 'â€”'}`;
      confirmBox.classList.remove('hidden');

      // mÃ³wimy do uÅ¼ytkownika
      await speakFromBackend('ZamÃ³wienie przyjÄ™te. ' + (data.steps?.[0]?.message || ''));

      showStatus('Gotowe.');
    } catch (e) {
      showStatus('BÅ‚Ä…d poÅ‚Ä…czenia.');
    }
  }

  // ====== ZDARZENIA ======
  sendBtn.addEventListener('click', () => handleQuery());
  micBtn.addEventListener('click', () => startMic());
  queryInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleQuery();
  });

  // ====== START: auto-instrukcja + prÃ³ba auto-mikrofonu ======
  const startup = async () => {
    const intro = 'Freeflow â€” po prostu zamÃ³w. Powiedz na gÅ‚os swoje zamÃ³wienie.';
    // mÃ³wimy od razu (to zwykle dziaÅ‚a bez gestu)
    speakLocal(intro);
    // sprÃ³buj wÅ‚Ä…czyÄ‡ mikrofon automatycznie (moÅ¼e wymagaÄ‡ gestu â€“ wtedy pokaÅ¼ hint)
    try {
      await startMic();
      hintEl.textContent = 'Mikrofon wÅ‚Ä…czony. MÃ³w Å›miaÅ‚o!';
    } catch {
      hintEl.textContent = 'Kliknij ikonÄ™ ğŸ¤, aby wÅ‚Ä…czyÄ‡ mikrofon.';
    }

    // plan B: pierwszy dotyk w dowolnym miejscu rÃ³wnieÅ¼ odpali mikrofon
    const oneTap = () => { startMic(); window.removeEventListener('pointerdown', oneTap); };
    window.addEventListener('pointerdown', oneTap, { once: true });
  };

  window.addEventListener('DOMContentLoaded', startup);
})();
</script>
</body>
</html>
