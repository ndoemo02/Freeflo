<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeFlow – Voice to order</title>

  <!-- TŁO z repo -->
  <style>
    :root{
      --bg:#0f141b;
      --panel:#141b23;
      --ring:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#ff7a00;
      --accent-2:#00d1ff;
    }
    html,body{
      height:100%;
      margin:0;
      background: #0b0f14 url("./assets/Background.png") center/cover no-repeat fixed;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      backdrop-filter: saturate(120%) blur(0px);
      background: radial-gradient(1500px 700px at 50% -200px, rgba(255,170,0,.08), transparent 60%);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:20px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px;
    }
    .brand img{ width:28px; height:28px; border-radius:6px; }
    .brand .free{ color:var(--accent); }
    .brand .flow{ color:white; opacity:.9; }

    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px 10px;
    }
    .ring{
      width:min(92vw, 460px);
      aspect-ratio:1/1;
      border-radius:50%;
      display:grid; place-items:center;
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.02) inset,
        0 50px 150px rgba(0,0,0,.55);
      background: radial-gradient(70% 70% at 50% 50%, rgba(255,255,255,.04), rgba(255,255,255,0) 60%);
    }

    /* LOGO jako przycisk */
    .micBtn{
      width:min(65vw, 320px);
      aspect-ratio:1/1;
      border-radius:30px;
      border:none;
      background: transparent url("./assets/logo.png") center/contain no-repeat;
      box-shadow:
        0 0 0 0 rgba(255,122,0,0),
        0 0 0 0 rgba(0,209,255,0);
      transition: transform .12s ease;
      position:relative;
    }
    .micBtn:active{ transform: scale(.985); }

    /* Mocny puls podczas nagrywania */
    .recording .micBtn{
      animation: pulse 1s ease-in-out infinite;
      filter: drop-shadow(0 0 18px rgba(255,122,0,.55))
              drop-shadow(0 0 28px rgba(0,209,255,.45));
    }
    @keyframes pulse{
      0%   { transform: scale(1.00); }
      50%  { transform: scale(1.06); }
      100% { transform: scale(1.00); }
    }

    /* Panel asystenta */
    .panel{
      margin:18px auto 26px;
      width:min(92vw, 780px);
      background: rgba(13,18,25,.76);
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .feed{
      max-height:38vh;
      overflow:auto;
      padding:16px 16px 6px;
      font-size:15px;
      line-height:1.45;
    }
    .msg{ padding:10px 12px; margin:8px 0; border-radius:12px; }
    .me{ background: rgba(255,255,255,.05); }
    .bot{ background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.05); }
    .muted{ color:var(--muted); font-size:13px; }

    .ctaRow{
      display:flex; gap:12px; padding:12px; justify-content:center; flex-wrap:wrap;
    }
    .chip{
      flex:1 1 120px; max-width:220px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:#fff; padding:14px 16px; border-radius:14px;
      text-align:center; font-weight:600; letter-spacing:.2px;
    }
    .chip:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <img src="./assets/logo.png" alt="FreeFlow">
        <div><span class="free">Free</span> <span class="flow">Flow</span></div>
      </div>
    </header>

    <section class="stage">
      <div class="ring" id="ring">
        <button id="logoBtn" class="micBtn" aria-label="Naciśnij i przytrzymaj, aby mówić"></button>
      </div>
    </section>

    <section class="panel">
      <div class="feed" id="feed">
        <div class="msg bot">Dotknij i PRZYTRZYMAJ logo, aby mówić. Zwolnij przycisk – dopiero wtedy wyślę zapytanie.</div>
      </div>
      <div class="ctaRow">
        <div class="chip">Jedzenie</div>
        <div class="chip">Taxi</div>
        <div class="chip">Hotel</div>
      </div>
    </section>
  </div>

  <script>
    // >>>>>>>>>>> KONFIG <<<<<<<<<<
    // Podmień na swoją domenę backendu (bez końcowego "/")
    const API_BASE = "https://freeflow-backend-vercel.vercel.app"; // <- Twoje Vercel/Render
    const ASR_URL  = API_BASE + "/api/asr";
    const ASSIST_URL = API_BASE + "/api/assistant-text"; // jeśli masz /api/chat – podmień

    // >>>>>>>>>>> STAN UI <<<<<<<<<<
    const ring  = document.getElementById('ring');
    const btn   = document.getElementById('logoBtn');
    const feed  = document.getElementById('feed');

    let mediaRecorder = null;
    let chunks = [];
    let isRecording = false;

    function addMsg(text, who='bot', muted=false){
      const div = document.createElement('div');
      div.className = `msg ${who} ${muted ? 'muted':''}`;
      div.textContent = text;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
      return div;
    }

    // Szybki test zdrowia backendu (bez blokady UI)
    fetch(API_BASE + "/api/health").catch(()=>{});

    // >>>>>>>>>>> NAGRYWANIE: PUSH-TO-TALK <<<<<<<<<<
    async function startRecording(){
      if(isRecording) return;
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = e => e.data.size && chunks.push(e.data);
        mediaRecorder.onstop = onStopRecording;

        mediaRecorder.start();
        isRecording = true;
        ring.classList.add('recording');
        addMsg("Nagrywam… mów śmiało. Zwolnij przycisk, aby wysłać.","bot",true);
      }catch(err){
        console.error(err);
        addMsg("Brak dostępu do mikrofonu.","bot");
      }
    }

    function stopRecording(){
      if(!isRecording || !mediaRecorder) return;
      isRecording = false;
      ring.classList.remove('recording');
      mediaRecorder.stop();
    }

    // Po puszczeniu – wysyłamy CAŁY klip (nie fragmenty)
    async function onStopRecording(){
      const blob = new Blob(chunks, { type: 'audio/webm' });
      chunks = [];
      const thinking = addMsg("Transkrybuję…","bot",true);

      try{
        const fd = new FormData();
        fd.append("audio", blob, "speech.webm");

        // 1) ASR – czekamy na finalny tekst
        const asrRes = await fetch(ASR_URL, { method:"POST", body: fd });
        if(!asrRes.ok) throw new Error("ASR failed");
        const { text } = await asrRes.json();

        thinking.remove();
        addMsg(text || "(pusto)", "me");

        if(!text || !text.trim()){
          addMsg("Nie dosłyszałem. Spróbuj jeszcze raz.","bot",true);
          return;
        }

        // 2) Asystent – dopiero po finalnym tekście
        const resp = await fetch(ASSIST_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ prompt: text })
        });
        const data = await resp.json();
        addMsg(data.reply || "OK.","bot");
      }catch(e){
        console.error(e);
        thinking.remove();
        addMsg("Błąd sieci lub backendu. Spróbuj ponownie.","bot");
      }
    }

    // Obsługa dotyku i myszy (mobile + desktop)
    const startEvt = ('ontouchstart' in window) ? 'touchstart' : 'mousedown';
    const endEvt   = ('ontouchend'   in window) ? 'touchend'   : 'mouseup';

    btn.addEventListener(startEvt, (e)=>{ e.preventDefault(); startRecording(); }, {passive:false});
    btn.addEventListener(endEvt,   (e)=>{ e.preventDefault(); stopRecording();  }, {passive:false});

    // Bezpiecznik – gdy palec wyjedzie poza ekran
    document.addEventListener('mouseleave', stopRecording);
    document.addEventListener('touchcancel', stopRecording);
  </script>
</body>
</html>
