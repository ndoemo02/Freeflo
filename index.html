<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreeFlow ‚Äî zam√≥w g≈Çosem</title>
  <link rel="preload" as="image" href="assets/Background.png">
  <style>
    :root{
      --text:#e9eef6; --muted:#a8b3c7; --brand:#ff7a00; --brand-2:#00d0ff;
      --glass:rgba(15,18,24,.55); --stroke:rgba(255,255,255,.08);
      --blur:14px;
    }
    /* Reset & mobile polish */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:#0b0f14 url("assets/Background.png") center / cover no-repeat fixed;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
    }
    img,svg{max-width:100%; display:block}
    button{font:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 18px}
    .row{display:flex;gap:12px;align-items:center}
    .grow{flex:1}
    .brand{
      display:flex;align-items:flex-end;gap:8px;font-weight:700;letter-spacing:.3px
    }
    .brand .orange{color:var(--brand);font-size:34px;line-height:1}
    .brand .white{color:#fff;font-size:34px;line-height:1}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke); backdrop-filter: blur(var(--blur));
      color:var(--text);
    }
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.28)}
    header .actions{display:flex;gap:10px}
    .icon-btn{
      width:52px;height:52px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);display:grid;place-items:center;
      cursor:pointer; user-select:none;
    }

    h1{font-size:40px;line-height:1.05;margin:14px 0 8px}
    .sub{color:var(--muted);font-size:18px;margin-bottom:10px}

    /* HERO: logo as button */
    .hero{
      margin:10px auto 10px; width:min(92vw,640px);
      position:relative; display:grid; place-items:center;
    }
    .logoBtn{
      position:relative; border:none; background:transparent; cursor:pointer;
      width:min(78vw,520px); aspect-ratio:1/1.05; display:grid; place-items:center;
      user-select:none;
    }
    .logoBtn img{width:100%; height:100%; object-fit:contain; pointer-events:none}
    /* subtle neon aura around mic while listening */
    .logoBtn::after{
      content:""; position:absolute; inset:0; border-radius:34px/38px;
      background: radial-gradient(40% 30% at 52% 38%, rgba(255,160,0,.55), transparent 55%),
                  radial-gradient(40% 40% at 50% 52%, rgba(0,200,255,.45), transparent 60%);
      opacity:0; transition:opacity .25s ease;
      filter: blur(18px);
      pointer-events:none;
    }
    /* Whole bubble pulse when listening */
    .listening{ animation: pulse 1.25s ease-in-out infinite }
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.025)}100%{transform:scale(1)}}
    .listening::after{ opacity:1 }

    /* Transcript input (above tiles) */
    .transcript{
      margin:6px auto 18px; width:min(92vw,900px);
      min-height:60px; display:flex; align-items:center; gap:12px;
      padding:16px 18px; border-radius:18px; background:var(--glass);
      border:1px solid var(--stroke); backdrop-filter:blur(var(--blur));
      font-size:20px; color:#fff;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:#7b8a9c;flex:0 0 10px}
    .dot.live{background:#35e06f; box-shadow:0 0 14px rgba(53,224,111,.7)}
    .mic-btn{
      margin-left:auto; width:48px;height:48px;border-radius:50%;
      display:grid; place-items:center; border:1px solid var(--stroke);
      background:rgba(255,255,255,.06); cursor:pointer; user-select:none;
    }

    /* Summary toast */
    .summary{
      position:relative; margin:14px auto 12px; width:min(92vw,900px);
      padding:16px 18px 10px; border-radius:18px; background:var(--glass);
      border:1px solid var(--stroke); backdrop-filter: blur(var(--blur));
    }
    .summary h3{margin:0 0 10px;font-size:24px}
    .li{display:flex;align-items:center;gap:10px;margin:8px 0}
    .li .em{font-size:22px}
    .close{
      position:absolute;right:12px;top:10px;width:36px;height:36px;border-radius:10px;
      background:rgba(255,255,255,.06);border:1px solid var(--stroke);display:grid;place-items:center;cursor:pointer
    }

    /* Tiles */
    .tiles{position:sticky; bottom:12px; display:flex; gap:14px; justify-content:center;
           padding:8px 10px}
    .tile{
      min-width:180px; padding:16px 22px; border-radius:22px;
      background:var(--glass); border:1px solid var(--stroke);
      backdrop-filter:blur(var(--blur)); display:flex; gap:10px;
      align-items:center; justify-content:center; font-size:20px; color:#fff;
    }
    .tile .emoji{font-size:22px}
    /* flash on intent */
    .flash{ animation: flash 1s ease-in-out 2 }
    @keyframes flash{0%,100%{opacity:1}50%{opacity:.25}}

    /* small helpers */
    .hide{display:none}
    .muted{color:var(--muted)}
    .center{text-align:center}

    /* ensure the drip (kropla) visible: spacing tweak */
    .hero + .transcript{ margin-top:0 }

    @media (min-width:900px){
      h1{font-size:56px}
      .sub{font-size:20px}
    }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="row">
      <div class="brand grow">
        <div class="orange">Free</div><div class="white">Flow</div>
      </div>
      <div class="actions">
        <div class="icon-btn" title="Menu" aria-label="Menu">‚â°</div>
        <div class="icon-btn" title="Koszyk" aria-label="Koszyk">üõí</div>
      </div>
    </div>
    <h1>Z≈Ç√≥≈º zam√≥wienie</h1>
    <div class="sub">Jedzenie, Taxi albo nocleg ‚Äî powiedz lub kliknij.</div>
  </header>

  <main class="wrap">
    <!-- HERO -->
    <section class="hero">
      <button id="logoBtn" class="logoBtn" aria-label="Naci≈õnij, aby m√≥wiƒá">
        <img id="logoImg" src="assets/freeflow-logo.svg"
             onerror="this.onerror=null;this.src='assets/Freeflowlogo.png'"
             alt="FreeFlow logo">
      </button>
    </section>

    <!-- SUMMARY (hidden by default) -->
    <section id="summary" class="summary hide shadow-soft" aria-live="polite">
      <button class="close" id="sumClose" aria-label="Zamknij">‚úï</button>
      <h3>Podsumowanie</h3>
      <div class="li"><span class="em">‚úÖ</span><span id="sumStatus">Status: gotowe</span></div>
      <div class="li"><span class="em">üçΩÔ∏è</span><span id="sumDish">Danie: ‚Äî</span></div>
      <div class="li"><span class="em">üïí</span><span id="sumTime">Czas: ‚Äî</span></div>
      <div class="li"><span class="em">üí≤</span><span class="muted">Cena: demo</span></div>
    </section>

    <!-- TRANSCRIPT -->
    <div class="transcript shadow-soft" id="transcriptBox">
      <div id="liveDot" class="dot"></div>
      <div id="transcript" class="grow muted">Powiedz, co chcesz zam√≥wiƒá‚Ä¶</div>
      <div id="micBtn" class="mic-btn" title="M√≥w / Stop">üé§</div>
    </div>
  </main>

  <!-- TILES -->
  <nav class="tiles wrap">
    <button id="tile-food" class="tile"><span class="emoji">üçΩÔ∏è</span><span>Jedzenie</span></button>
    <button id="tile-taxi" class="tile"><span class="emoji">üöï</span><span>Taxi</span></button>
    <button id="tile-hotel" class="tile"><span class="emoji">üè°</span><span>Hotel</span></button>
  </nav>

  <script>
  // --- UI helpers
  const $ = sel => document.querySelector(sel);
  const logoBtn = $('#logoBtn');
  const liveDot = $('#liveDot');
  const transcriptEl = $('#transcript');
  const transcriptBox = $('#transcriptBox');
  const micBtn = $('#micBtn');
  const summary = $('#summary');
  const sumClose = $('#sumClose');
  const sumDish = $('#sumDish');
  const sumTime = $('#sumTime');

  function showSummary(data){
    if (data?.dish) sumDish.textContent = 'Danie: ' + data.dish;
    if (data?.time) sumTime.textContent = 'Czas: ' + data.time;
    summary.classList.remove('hide');
  }
  sumClose.onclick = () => summary.classList.add('hide');

  // flash tiles on intents
  function flashIcon(id){
    const el = document.getElementById(id);
    el.classList.add('flash');
    setTimeout(()=>el.classList.remove('flash'), 1200);
  }

  // --- Speech: Web Speech API (Chrome/Edge)
  let recognition = null;
  let listening = false;
  let lastTranscript = '';

  function ensureSpeech(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const rec = new SR();
    rec.lang = 'pl-PL';
    rec.interimResults = true;
    rec.continuous = false;
    rec.maxAlternatives = 1;
    return rec;
  }

  function setListeningUI(on){
    listening = on;
    logoBtn.classList.toggle('listening', on);
    liveDot.classList.toggle('live', on);
    transcriptBox.style.borderColor = on ? 'rgba(0,210,120,.55)' : 'var(--stroke)';
  }

  function startRecognition(){
    if (!recognition){
      recognition = ensureSpeech();
      if (!recognition){
        transcriptEl.textContent = 'Rozpoznawanie mowy jest dostƒôpne w Chrome / Edge.';
        return;
      }
      recognition.onstart = () => setListeningUI(true);
      recognition.onend   = () => setListeningUI(false);

      recognition.onerror = (e) => {
        setListeningUI(false);
        transcriptEl.textContent = 'B≈ÇƒÖd rozpoznawania: ' + (e.error || 'nieznany');
      };

      recognition.onresult = (event) => {
        let txt = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          txt += event.results[i][0].transcript;
        }
        txt = txt.trim();

        // dedupe ‚Äûdwie dwie‚Ä¶‚Äù
        if (txt === lastTranscript) return;
        lastTranscript = txt;

        transcriptEl.classList.remove('muted');
        transcriptEl.textContent = txt;

        // Detect simple intents for tile flash
        const lower = txt.toLowerCase();
        if (/(pizza|pierogi|pepperoni|jedzenie|zjedz)/.test(lower)) flashIcon('tile-food');
        if (/(taxi|taks√≥wka|dojazd)/.test(lower)) flashIcon('tile-taxi');
        if (/(hotel|nocleg|pok√≥j)/.test(lower)) flashIcon('tile-hotel');

        // On final result -> parse & show summary, speak back
        const isFinal = event.results[event.results.length-1].isFinal;
        if (isFinal) {
          const parsed = parseOrder(lower);
          if (parsed.dish || parsed.time){
            showSummary(parsed);
            speak(`OK. ${parsed.dish?('Zamawiam: '+parsed.dish+'. '):''}${parsed.time?('Na godzinƒô '+parsed.time+'.'):''}`);
          }
        }
      };
    }
    try{
      lastTranscript = '';
      recognition.start();
    }catch(_){/* if already started */}
  }

  function stopRecognition(){
    if (recognition) { try{ recognition.stop(); }catch(_){} }
  }

  // Simple PL NLU (demo)
  function parseOrder(lower){
    // danie: s≈Çowa po s≈Çowach kluczowych
    let dish = '';
    const dishMatch = lower.match(/(zam(?:awiam)?|chcƒô|poprosz?ƒô|dla mnie)?\s*([a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º0-9 ]{3,})/i);
    if (dishMatch) dish = dishMatch[2].trim();

    // czas: 18:30 / 18.30 / na 18 / o 18
    let time = '';
    const t1 = lower.match(/\b([01]?\d|2[0-3])[:\.]([0-5]\d)\b/);
    if (t1) time = `${t1[1].padStart(2,'0')}:${t1[2]}`;
    else{
      const t2 = lower.match(/\b(?:na|o)\s*([01]?\d|2[0-3])\b/);
      if (t2) time = `${String(t2[1]).padStart(2,'0')}:00`;
    }
    // Oczy≈õƒá powt√≥rzenia: "dwie pepperoni" -> zostaw
    dish = dish.replace(/\b(dwie|trzy)\s+\1\b/g,'$1'); // proste zbijanie dubli
    return {dish, time};
  }

  // TTS
  function speak(text){
    if (!window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'pl-PL';
    u.rate = 1; u.pitch = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // Click handlers
  logoBtn.addEventListener('click', () => {
    if (!listening) startRecognition(); else stopRecognition();
  });
  micBtn.addEventListener('click', () => {
    if (!listening) startRecognition(); else stopRecognition();
  });

  // Tiles
  $('#tile-food').onclick  = () => { flashIcon('tile-food'); speak('Jedzenie. Co podaƒá?'); };
  $('#tile-taxi').onclick  = () => { flashIcon('tile-taxi'); speak('Taxi. DokƒÖd jedziemy?'); };
  $('#tile-hotel').onclick = () => { flashIcon('tile-hotel'); speak('Hotel. Na kt√≥rƒÖ godzinƒô?'); };

  // Prevent blue tap overlay on mobile
  document.querySelectorAll('button, .icon-btn, .tile, .logoBtn').forEach(el=>{
    el.style.webkitTapHighlightColor = 'transparent';
  });
  </script>
</body>
</html>
