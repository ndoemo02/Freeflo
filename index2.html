<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FreeFlow</title>
<style>
  :root{
    --bg:#0c0f14;
    --panel:rgba(22,24,32,.72);
    --panel-border:rgba(255,255,255,.08);
    --text:#e8eef8;
    --accent:#ff9c2f;
  }
  html,body{height:100%;margin:0;background:#0c0f14;color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  /* T≈ÅO */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:url("./background.png") center/cover no-repeat fixed;
    filter:none; opacity:.75;
    pointer-events:none; z-index:-2;
  }
  /* MASKA delikatnego przyciemnienia */
  body::after{
    content:""; position:fixed; inset:0;
    background:radial-gradient(transparent 30%, rgba(0,0,0,.55) 100%);
    pointer-events:none; z-index:-1;
  }

  /* G√≥rny pasek */
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));
    position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(6px);
  }
  .brand{letter-spacing:.24em; font-weight:800}
  .actions{display:flex; gap:10px}
  .btn-ghost{
    display:grid; place-items:center; width:44px; height:44px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid var(--panel-border);
  }

  /* G≈Å√ìWNY KADR */
  main{max-width:960px; margin:0 auto; padding:24px 16px 120px}

  /* Logo ‚Äì przycisk */
  #logoBtn{
    width:min(76vw,380px); aspect-ratio:0.82/1;
    margin:24px auto 14px; display:block; border:0; background:transparent; cursor:pointer;
    position:relative; transform:translateZ(0);
  }
  #logoBtn img{
    width:100%; height:100%; object-fit:contain; display:block; filter:drop-shadow(0 14px 26px rgba(0,0,0,.45));
    transition:transform .15s ease;
  }
  #logoBtn:active img{ transform:scale(.985) }
  /* Puls podczas nagrywania */
  #logoBtn.listening::after{
    content:""; position:absolute; inset:-6%; border-radius:40% 40% 56% 56% / 44% 44% 60% 60%;
    box-shadow:0 0 0 0 rgba(255,156,47,.55);
    animation:pulse 1.4s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{transform:scale(1); box-shadow:0 0 0 0 rgba(255,156,47,.55)}
    70%{transform:scale(1.02); box-shadow:0 0 0 24px rgba(255,156,47,0)}
    100%{transform:scale(1); box-shadow:0 0 0 0 rgba(255,156,47,0)}
  }

  /* Panel transkrypcji ‚Äì ni≈ºej, na ≈õrodku */
  #transcript{
    max-width:720px; margin:18px auto 0; padding:14px 16px;
    background:var(--panel); border:1px solid var(--panel-border); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25); min-height:72px; max-height:38vh; overflow:auto;
  }
  #transcript p{margin:6px 0}
  #transcript p strong{color:#9ed0ff}

  /* Dolny dock z przyciskami */
  .dock{
    position:fixed; left:0; right:0; bottom:18px; display:flex; justify-content:center; z-index:15;
  }
  .dock-inner{
    display:flex; gap:14px; padding:14px 16px; border-radius:18px;
    background:rgba(10,12,18,.78); border:1px solid var(--panel-border); backdrop-filter:blur(8px) saturate(140%);
  }
  .chip{
    display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:16px;
    background:rgba(255,255,255,.06); border:1px solid var(--panel-border); color:var(--text); font-weight:600;
  }
  .pill{
    margin-left:12px; padding:8px 12px; border-radius:999px; font-size:.9rem; border:1px solid var(--panel-border);
    background:rgba(255,255,255,.06); cursor:pointer;
  }

  a,button{color:inherit}
  *{box-sizing:border-box}
</style>
</head>
<body>

<header>
  <div class="brand">FREEFLOW</div>
  <div class="actions">
    <button id="liveToggle" class="pill" title="CiƒÖg≈Ça transkrypcja w przeglƒÖdarce (Chrome)">Live voice: OFF</button>
    <div class="btn-ghost" aria-label="Menu">‚ò∞</div>
    <div class="btn-ghost" aria-label="Koszyk">üõí</div>
  </div>
</header>

<main>
  <!-- PRZYCISK LOGO -->
  <button id="logoBtn" aria-label="Click to talk">
    <img src="./Freeflow-logo.png" alt="FreeFlow Logo" />
  </button>

  <!-- PANEL TRANSKRYPCJI -->
  <div id="transcript" aria-live="polite" aria-label="Transkrypcja"></div>
</main>

<!-- DOLNY DOCK -->
<div class="dock">
  <div class="dock-inner">
    <a class="chip" href="#food">üçΩÔ∏è Jedzenie</a>
    <a class="chip" href="#taxi">üöï Taxi</a>
    <a class="chip" href="#hotel">üè® Hotel</a>
  </div>
</div>

<script>
/* ========= KONFIG ========= */
const BACKEND = 'https://freeflow-backend-vercel.vercel.app';

/* ========= UTIL ========= */
function addLine(text, who="Asystent"){
  const box = document.getElementById('transcript');
  const p = document.createElement('p');
  if (who) p.innerHTML = `<strong>${who}:</strong> ${text}`;
  else p.textContent = text;
  box.appendChild(p);
  box.scrollTop = box.scrollHeight;
}

/* ========= TTS z backendu ========= */
async function speak(text){
  try{
    const r = await fetch(`${BACKEND}/api/tts`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ text })
    });
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = new Audio(url);
    a.play();
  }catch(e){ console.error('TTS error', e); }
}

/* ========= ASR ‚Äì tryb wysy≈Çki nagrania do backendu ========= */
async function serverTranscribe(blob){
  try{
    const fd = new FormData();
    fd.append('audio', blob, 'audio.webm');
    const r = await fetch(`${BACKEND}/api/asr`, { method:'POST', body:fd });
    const j = await r.json().catch(()=> ({}));
    return j.text || j.transcript || "";
  }catch(e){ console.error('ASR error', e); return ""; }
}

/* ========= Browser Live Voice (Web Speech API) ========= */
let liveMode = false;
let rec; // SpeechRecognition
function initLive(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('Live voice wymaga Chrome/Edge z Web Speech API.'); return null; }
  const r = new SR();
  r.lang = 'pl-PL';
  r.continuous = true;
  r.interimResults = true;
  r.onresult = (e)=>{
    let finalText = "", interim = "";
    for(let i=e.resultIndex; i<e.results.length; i++){
      const t = e.results[i][0].transcript;
      if(e.results[i].isFinal) finalText += t + " ";
      else interim += t;
    }
    if(interim) { /* mo≈ºna pokazaƒá ‚Äû‚Ä¶s≈Çucham‚Äù ‚Äì pomijamy dla prostoty */ }
    if(finalText){
      addLine(finalText.trim(), "U≈ºytkownik");
      const reply = "Zrozumia≈Çam: " + finalText.trim();
      addLine(reply, "Asystent");
      speak(reply);
    }
  };
  r.onerror = (e)=> console.warn('SR error', e.error);
  r.onend = ()=> { if(liveMode) try{ r.start(); }catch{} };
  return r;
}

document.getElementById('liveToggle').addEventListener('click', ()=>{
  liveMode = !liveMode;
  const btn = document.getElementById('liveToggle');
  btn.textContent = 'Live voice: ' + (liveMode?'ON':'OFF');
  if(liveMode){
    if(!rec) rec = initLive();
    if(rec) try{ rec.start(); }catch(e){}
    addLine('Tryb live voice w≈ÇƒÖczony (transkrypcja lokalna).');
  }else{
    try{ rec && rec.stop(); }catch(e){}
    addLine('Tryb live voice wy≈ÇƒÖczony.');
  }
});

/* ========= Nagrywanie klik‚Äìm√≥w‚Äìpu≈õƒá (MediaRecorder) ========= */
let mediaRecorder, isRecording=false, chunks=[];
async function startRecording(){
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  mediaRecorder = new MediaRecorder(stream, { mimeType:'audio/webm' });
  chunks = [];
  mediaRecorder.ondataavailable = (e)=> e.data.size && chunks.push(e.data);
  mediaRecorder.onstop = async ()=>{
    const blob = new Blob(chunks, { type:'audio/webm' });
    const text = await serverTranscribe(blob);
    if(text){
      addLine(text, "U≈ºytkownik");
      const reply = "Zrozumia≈Çam: " + text;
      addLine(reply, "Asystent");
      speak(reply);
    }else{
      addLine('Nie uda≈Ço siƒô rozpoznaƒá mowy.', "Asystent");
    }
  };
  mediaRecorder.start();
}
async function stopRecording(){
  try{ mediaRecorder?.state === 'recording' && mediaRecorder.stop(); }catch{}
}

/* ========= Obs≈Çuga logo ========= */
const logoBtn = document.getElementById('logoBtn');
logoBtn.addEventListener('click', async ()=>{
  isRecording = !isRecording;
  logoBtn.classList.toggle('listening', isRecording);

  if(isRecording){
    addLine('Prze≈ÇƒÖczanie nagrywania: OFF‚ÜíON');
    speak('Nagrywanie w≈ÇƒÖczone. S≈Çucham.');
    startRecording();
  }else{
    addLine('Prze≈ÇƒÖczanie nagrywania: ON‚ÜíOFF');
    speak('Nagrywanie wy≈ÇƒÖczone.');
    await stopRecording();
  }
});

/* ========= Powitanie ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  speak('W celu z≈Ço≈ºenia zam√≥wienia proszƒô nacisnƒÖƒá logo. Po aktywacji trybu g≈Çosowego dopytam o szczeg√≥≈Çy.');
  addLine('Transkrypcja serwerowa aktywna. Kliknij logo, aby m√≥wiƒá.');
});
</script>
</body>
</html>
