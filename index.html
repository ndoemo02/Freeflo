<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FreeFlow – Voice to order</title>

  <!-- Podstawowy styl + Twoje nadpiski z JSON/CSS -->
  <style>
    :root{
      --brand:#ff7a1a; --accent:#15ffb6; --bg-1:#0c0f12; --bg-2:#12161b;
      --text-1:rgba(255,255,255,.92); --text-2:rgba(255,255,255,.64);
      --radius:18px; --logo-scale:1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text-1);
      background:radial-gradient(1200px 800px at 50% -200px, #1b1f25 0%, var(--bg-1) 40%, var(--bg-2) 100%);
    }
    a,button{outline:none}
    .wrap{max-width:980px; margin:0 auto; padding:20px 16px 56px}

    /* Header */
    .header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 0 2px}
    .brand{display:flex; align-items:baseline; gap:10px; font-weight:700; letter-spacing:.3px}
    .brand .free{color:var(--brand); font-size:32px}
    .brand .flow{color:var(--text-1); opacity:.9; font-size:32px}
    .subtitle-mini{color:var(--text-2); font-size:14px; line-height:1.1}

    .hdr-actions{display:flex; gap:10px; align-items:center}
    .icon-btn{
      position:relative; display:flex; align-items:center; justify-content:center;
      width:48px; height:48px; border-radius:16px; background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(4px);
      box-shadow:0 8px 24px rgba(0,0,0,.35); transition:transform .15s ease, background .15s ease;
    }
    .icon-btn:active{transform:scale(.97)}
    .badge{
      position:absolute; top:-6px; right:-6px; background:var(--brand); color:#111; font-weight:700;
      width:22px; height:22px; border-radius:999px; display:flex; align-items:center; justify-content:center;
      font-size:12px; box-shadow:0 6px 16px rgba(255,122,26,.4);
    }
    .cart{display:var(--show-cart,flex)}
    .menu{display:var(--show-menu,flex)}

    /* Tytuły */
    h1{font-size:40px; margin:16px 0 6px}
    h2{font-size:18px; font-weight:500; color:var(--text-2); margin:0 0 22px}

    /* Logo = przycisk */
    .logo-zone{display:grid; place-items:center; margin:8px 0 14px}
    .logo-wrap{
      position:relative; width:min(88vw,520px); aspect-ratio:1/1; display:grid; place-items:center;
      border-radius:999px; transform:scale(var(--logo-scale));
    }
    #logoButton{
      position:relative; width:100%; height:100%; border-radius:999px; border:none; padding:0; background:#000;
      display:block; cursor:pointer; overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 30px 80px rgba(0,0,0,.55);
    }
    #logoButton img{width:100%; height:100%; object-fit:cover; display:block}

    /* punktowe kropki na obręczy */
    .rim{
      position:absolute; inset:12px; border-radius:999px; pointer-events:none;
      background: radial-gradient(closest-side, rgba(255,255,255,.06), transparent 60%);
      mask: radial-gradient(farthest-side, transparent 88%, #000 89%);
    }

    /* podpowiedź / live transkrypcja na logo */
    #micHint{
      position:absolute; bottom:12%; left:50%; transform:translateX(-50%);
      display:flex; align-items:center; gap:10px;
      background:rgba(0,0,0,.55); color:var(--text-1);
      border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:12px 16px;
      box-shadow:0 12px 36px rgba(0,0,0,.45); backdrop-filter: blur(8px);
      font-size:16px; min-width:220px; max-width:70%; text-align:center;
      transition:opacity .18s ease, transform .18s ease;
    }
    .led{width:10px; height:10px; border-radius:999px; background:#58ff75; box-shadow:0 0 10px #58ff75}

    /* Transkrypcja w polu pod logo */
    .transcript{
      display:flex; align-items:center; gap:12px; border-radius:20px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
      padding:16px 18px; margin:10px 0 18px;
    }
    .transcript .led{width:12px; height:12px}
    .transcript p{margin:0; color:var(--text-1); opacity:.9; min-height:1.2em}

    /* chips menu */
    .chips{display:flex; gap:14px; flex-wrap:wrap}
    .chip{
      border:none; padding:12px 18px; border-radius:18px; background:rgba(255,255,255,.06);
      color:var(--text-1); font-weight:600; letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.10); box-shadow:0 10px 26px rgba(0,0,0,.35);
    }

    /* bottom info */
    .note{color:var(--text-2); font-size:13px; margin-top:20px}

    /* słucham */
    body.listening .led{background:#ff5e5e; box-shadow:0 0 10px #ff5e5e}
    body.listening .logo-wrap::after{
      content:""; position:absolute; inset:-8px; border-radius:999px;
      box-shadow:0 0 0 0 rgba(255,122,26,.35); animation:pulse 1.9s ease-out infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(255,122,26,.35)}
      70%{box-shadow:0 0 0 28px rgba(255,122,26,0)}
      100%{box-shadow:0 0 0 0 rgba(255,122,26,0)}
    }

    /* prosty sheets menu */
    .sheet{position:fixed; inset:0; display:none}
    .sheet.open{display:block}
    .sheet .back{position:absolute; inset:0; background:rgba(0,0,0,.3)}
    .sheet .panel{
      position:absolute; top:12px; right:12px; background:rgba(18,22,27,.96); color:var(--text-1);
      border:1px solid rgba(255,255,255,.08); border-radius:18px; width:220px; padding:12px;
      box-shadow:0 24px 80px rgba(0,0,0,.55)
    }
    .sheet .panel h4{margin:6px 8px 10px; font-size:14px; color:var(--text-2); font-weight:600}
    .sheet .panel a{display:block; padding:10px 12px; border-radius:12px; color:var(--text-1); text-decoration:none}
    .sheet .panel a:hover{background:rgba(255,255,255,.06)}
  </style>

  <link rel="stylesheet" href="ui-overrides.css">
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="header">
      <div class="brand">
        <div class="free">Free</div><div class="flow">Flow</div>
      </div>
      <div class="subtitle-mini">Voice to order</div>
      <div class="hdr-actions">
        <button id="menuBtn" class="icon-btn menu" aria-label="Menu" title="Menu">
          <!-- hamburger -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="6" width="18" height="2" rx="1" fill="white" opacity=".9"/>
            <rect x="3" y="11" width="18" height="2" rx="1" fill="white" opacity=".9"/>
            <rect x="3" y="16" width="18" height="2" rx="1" fill="white" opacity=".9"/>
          </svg>
        </button>
        <button class="icon-btn cart" aria-label="Koszyk" title="Koszyk">
          <!-- cart -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M3 5h2l2.6 10.2a2 2 0 0 0 2 1.6h7.8a2 2 0 0 0 2-1.6L21 8H7" stroke="white" stroke-width="1.6"/>
            <circle cx="10" cy="20" r="1.6" fill="white"/><circle cx="18" cy="20" r="1.6" fill="white"/>
          </svg>
          <span class="badge" data-bind="cartCount">0</span>
        </button>
      </div>
    </header>

    <!-- Tytuły -->
    <h1 data-bind="title">Złóż zamówienie</h1>
    <h2 data-bind="subtitle">Taxi, posiłek, a może nocleg?</h2>

    <!-- Logo (przycisk) -->
    <section class="logo-zone">
      <div class="logo-wrap" id="logoWrap">
        <button id="logoButton" aria-label="Dotknij logo i mów">
          <img src="Freeflow-logo.png" alt="FreeFlow logo">
        </button>
        <div class="rim"></div>

        <div id="micHint"><span class="led" id="hintLed"></span><span id="hintText">Dotknij logo i mów…</span></div>
      </div>
    </section>

    <!-- Transkrypcja -->
    <div class="transcript" id="transcriptBox">
      <span class="led" id="led"></span>
      <p id="transcript">Transkrypcja pojawi się tutaj…</p>
    </div>

    <!-- Menu kategorii -->
    <div class="chips" data-bind="menu">
      <button class="chip">Jedzenie</button>
      <button class="chip">Taxi</button>
      <button class="chip">Hotel</button>
    </div>

    <p class="note">Demo: Web Speech API (rozpoznawanie mowy). Najlepiej działa w Chrome/Edge na Android.</p>
  </div>

  <!-- Proste sheet menu -->
  <div class="sheet" id="sheet">
    <div class="back" id="sheetBack"></div>
    <div class="panel">
      <h4>Menu</h4>
      <a href="#">Moje zamówienia</a>
      <a href="#">Ustawienia</a>
      <a href="#">Pomoc</a>
    </div>
  </div>

  <!-- Loader konfiguracji (JSON + CSS variables) -->
  <script>
  (async function remoteConfig(){
    function qs(sel){return document.querySelector(sel)}
    async function fetchJson(url){
      const r = await fetch(url+'?v='+Date.now()); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
    }
    function applyTheme(theme){
      const root=document.documentElement; (Object.entries(theme||{})).forEach(([k,v])=>root.style.setProperty(k,v));
    }
    function applyFlags(flags){
      document.documentElement.style.setProperty('--show-cart', flags?.showCart?'flex':'none');
      document.documentElement.style.setProperty('--show-menu', flags?.showMenu?'flex':'none');
      document.body.classList.toggle('pulsing', !!flags?.pulseLogo);
    }
    async function applyConfig(){
      try{
        const cfg = await fetchJson('freeflow-config.json');
        const h1 = qs('[data-bind="title"]'), h2 = qs('[data-bind="subtitle"]');
        const cart = qs('[data-bind="cartCount"]'), menu = qs('[data-bind="menu"]');
        if(h1&&cfg.title) h1.textContent=cfg.title;
        if(h2&&cfg.subtitle) h2.textContent=cfg.subtitle;
        if(cart && typeof cfg.cartCount==='number') cart.textContent=cfg.cartCount;
        if(menu && Array.isArray(cfg.menu)){ menu.innerHTML=''; cfg.menu.forEach(l=>{const b=document.createElement('button'); b.className='chip'; b.textContent=l; menu.appendChild(b);});}
        applyTheme(cfg.theme); applyFlags(cfg.flags);
        if(cfg.voice?.sessionMs) window.__VOICE_SESSION_MS__ = cfg.voice.sessionMs;
      }catch(e){console.warn('Config not loaded (ok on first run):', e);}
    }
    await applyConfig();
    setInterval(applyConfig, 8000);
  })();
  </script>

  <!-- Rozpoznawanie mowy -->
  <script>
  (function(){
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const logoBtn = document.getElementById('logoButton');
    const led = document.getElementById('led');
    const hintLed = document.getElementById('hintLed');
    const hintText = document.getElementById('hintText');
    const transcriptEl = document.getElementById('transcript');
    const sheet = document.getElementById('sheet');
    const menuBtn = document.getElementById('menuBtn');
    const sheetBack = document.getElementById('sheetBack');

    // Menu
    menuBtn.addEventListener('click', ()=> sheet.classList.add('open'));
    sheetBack.addEventListener('click', ()=> sheet.classList.remove('open'));

    // Stan nasłuchu
    let recog = null, listening = false, stopAt = 0, manualStop = false;

    function setListening(on){
      listening = on;
      document.body.classList.toggle('listening', on);
      led.style.background = on ? '#ff5e5e' : '#58ff75';
      led.style.boxShadow = on ? '0 0 10px #ff5e5e' : '0 0 10px #58ff75';
      hintLed.style.background = led.style.background;
      hintLed.style.boxShadow = led.style.boxShadow;
      hintText.textContent = on ? 'Słucham… mów śmiało' : 'Dotknij logo i mów…';
    }

    function ensureRecognizer(){
      if(!Recognition) return null;
      if (recog) return recog;
      recog = new Recognition();
      try{
        recog.lang = 'pl-PL';
        recog.interimResults = true;
        recog.continuous = true; // w Chrome Android i tak bywa przerywane — poniżej auto-restart
      }catch(e){}
      return recog;
    }

    function startListening(){
      const R = ensureRecognizer();
      if(!R){ transcriptEl.textContent = 'Rozpoznawanie mowy nie jest dostępne w tej przeglądarce.'; return; }

      // Wymuś zapytanie o uprawnienia (czasem Chrome pyta dopiero przy getUserMedia)
      if (navigator.mediaDevices?.getUserMedia) {
        navigator.mediaDevices.getUserMedia({audio:true}).catch(()=>{});
      }

      manualStop = false;
      const session = window.__VOICE_SESSION_MS__ || 20000;
      stopAt = Date.now() + session;
      let finalText = '', interim = '';

      R.onresult = (e)=>{
        interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++){
          const txt = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += (finalText ? ' ' : '') + txt.trim();
          else interim += txt;
        }
        transcriptEl.textContent = finalText || interim || '…';
      };
      R.onend = ()=>{
        if(manualStop){ setListening(false); return; }
        // Jeśli jeszcze w oknie czasu – uruchom ponownie (Android ucina szybko)
        if(Date.now() < stopAt - 200){
          try{ R.start(); }catch(_){}
        }else{
          setListening(false);
        }
      };
      R.onerror = (ev)=>{
        console.warn('Speech error:', ev.error);
        if(ev.error==='not-allowed' || ev.error==='service-not-allowed'){
          transcriptEl.textContent = 'Brak dostępu do mikrofonu. Sprawdź uprawnienia przeglądarki.';
        }
      };

      try{
        R.start();
        setListening(true);
      }catch(e){
        // jeśli safari/chrome nie pozwolił, spróbuj jeszcze raz po chwili
        setTimeout(()=>{ try{R.start(); setListening(true);}catch(_){ } }, 120);
      }
      // Awaryjne zatrzymanie po czasie
      setTimeout(()=> stopListening(true), session + 500);
    }

    function stopListening(fromTimer=false){
      if(!recog) return;
      manualStop = !fromTimer;
      try{ recog.stop(); }catch(_){}
      setListening(false);
    }

    // Tap/hold – start/stop
    // pointerdown: szybciej działa na Android niż click
    logoBtn.addEventListener('pointerdown', ()=>{
      if(!listening) startListening();
      else stopListening();
    });

  })();
  </script>
</body>
</html>
