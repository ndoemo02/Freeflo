<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FreeFlow ‚Äî zam√≥w g≈Çosem</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --fg:#e9eef6; --muted:#a8b3c7; --brand:#ff7a00;
    --glass-bg: rgba(0,0,0,.36); --glass-bd: rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);
    background:#0b0f14 url("assets/Background.png") center/cover fixed no-repeat;
  }
  .hdr{display:flex;gap:12px;align-items:center;padding:16px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))}
  .brand{font-size:28px;font-weight:800}
  .brand em{color:var(--brand);font-style:normal}
  .muted{color:var(--muted);font-size:13px}
  .spacer{flex:1}
  .btn-ico{height:44px;width:44px;border-radius:14px;display:grid;place-items:center;background:var(--glass-bg);border:1px solid var(--glass-bd);backdrop-filter:blur(8px)}
  h1{margin:6px 16px 6px;font-size:34px}
  .lead{margin:0 16px 2px;color:#c9d3e3}

  /* Logo wy≈ºej */
  .hero{display:grid;place-items:center;margin:0 0 4px}
  .logo-wrap{width:min(84vw,520px);aspect-ratio:1/1}
  .logo-wrap object,.logo-wrap svg{width:100%;height:100%;display:block}

  /* Transkrypcja wy≈ºej (tu≈º nad kafelkami) */
  #transcript{
    position:fixed;left:16px;right:16px;
    bottom:calc(108px + max(16px, env(safe-area-inset-bottom))); /* by≈Ço 72px ‚Äì teraz wy≈ºej */
    z-index:40;padding:14px 16px;min-height:48px;font-size:16px;
    background:var(--glass-bg);border:1px solid var(--glass-bd);border-radius:16px;backdrop-filter:blur(8px)
  }

  /* Kafelki */
  .bottom{position:fixed;left:16px;right:16px;bottom:max(16px,env(safe-area-inset-bottom));display:flex;gap:14px;z-index:30}
  .tile{flex:1;height:72px;border-radius:18px;display:flex;align-items:center;justify-content:center;gap:10px;
    background:var(--glass-bg);border:1px solid var(--glass-bd);backdrop-filter:blur(10px);font-weight:700;color:#fff}
  .tile.active{background:rgba(20,28,38,.46);outline:2px solid rgba(64,171,255,.55)}
  /* miganie kategorii */
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
  .tile.blink{animation:blink .9s linear 6}

  /* Podsumowanie */
  .summary{margin:12px 16px 120px;padding:16px;background:var(--glass-bg);border:1px solid var(--glass-bd);border-radius:16px;backdrop-filter:blur(8px)}
  .summary h2{margin:0 0 10px;font-size:18px}
  .summary ul{list-style:none;margin:0;padding:0}
  .summary li{margin:6px 0;display:flex;gap:8px;align-items:center}
  .hint{margin:6px 16px;color:#cbd6e6;font-size:13px;opacity:.9}

  /* glow dla SVG (aplikowane do #mic, #icon-food/#icon-taxi/#icon-hotel je≈õli istniejƒÖ) */
  .svg-glow{filter:drop-shadow(0 0 10px rgba(255,122,0,.8)) drop-shadow(0 0 20px rgba(255,122,0,.6))}
  .svg-blink{animation:blink .9s linear infinite}
</style>
</head>
<body>
  <header class="hdr">
    <div>
      <div class="brand"><em>Free</em> Flow</div>
      <div class="muted">Voice to order ‚Äî tryb testowy, bez profilowania</div>
    </div>
    <div class="spacer"></div>
    <div class="btn-ico" aria-label="Menu">‚â°</div>
    <div class="btn-ico" aria-label="Koszyk">üõí</div>
  </header>

  <main>
    <h1>Z≈Ç√≥≈º zam√≥wienie</h1>
    <p class="lead">Jedzenie, Taxi albo nocleg ‚Äî powiedz lub kliknij.</p>

    <!-- logo jako SVG (≈ºeby m√≥c modyfikowaƒá elementy w ≈õrodku) -->
    <section class="hero">
      <div class="logo-wrap">
        <object id="ffLogo" type="image/svg+xml" data="assets/freeflow-logo.svg" aria-label="FreeFlow logo"></object>
      </div>
    </section>
    <p class="hint" id="sttHint" style="display:none;">üé§ Rozpoznawanie mowy nie jest wspierane w tej przeglƒÖdarce.</p>
  </main>

  <div id="transcript">S≈Çucham‚Ä¶</div>

  <nav class="bottom">
    <button id="btn-food"  class="tile">üçΩÔ∏è Jedzenie</button>
    <button id="btn-taxi"  class="tile">üöï Taxi</button>
    <button id="btn-hotel" class="tile">üè° Hotel</button>
  </nav>

  <section id="summaryBox" class="summary" style="display:none;">
    <h2>Podsumowanie</h2>
    <ul id="summaryList"></ul>
  </section>

<script>
/* ===== helpers UI ===== */
const $t = document.getElementById('transcript');
const $sumBox = document.getElementById('summaryBox');
const $sumList = document.getElementById('summaryList');
const $hint = document.getElementById('sttHint');
const tiles = {
  food:  document.getElementById('btn-food'),
  taxi:  document.getElementById('btn-taxi'),
  hotel: document.getElementById('btn-hotel'),
};

/* ===== dostƒôp do element√≥w w SVG (po za≈Çadowaniu) ===== */
let svgDoc=null, svgMic=null, svgFood=null, svgTaxi=null, svgHotel=null;
const logoObj = document.getElementById('ffLogo');
logoObj.addEventListener('load', () => {
  svgDoc = logoObj.contentDocument;
  if(!svgDoc) return;
  svgMic   = svgDoc.getElementById('mic');
  svgFood  = svgDoc.getElementById('icon-food');
  svgTaxi  = svgDoc.getElementById('icon-taxi');
  svgHotel = svgDoc.getElementById('icon-hotel');
});

/* ===== STT ===== */
let recognition=null, isListening=false;
function sttSupported(){
  return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
}
function initSTT(){
  if(recognition) return;
  const Ctor = window.webkitSpeechRecognition || window.SpeechRecognition;
  if(!Ctor){ $hint.style.display='block'; return; }
  recognition = new Ctor();
  recognition.lang='pl-PL'; recognition.continuous=true; recognition.interimResults=true;

  let finalText='';
  recognition.onstart=()=>{
    isListening=true;
    addMicGlow(true);
    setTranscript('S≈Çucham‚Ä¶');
    finalText='';
  };
  recognition.onresult=(e)=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal) finalText += r[0].transcript+' ';
      else interim += r[0].transcript;
    }
    const text = cleanTranscript((finalText+interim).trim());
    setTranscript(text);
  };
  recognition.onerror=(e)=>{ console.warn('STT error',e); stopSTT(); };
  recognition.onend=()=>{ isListening=false; addMicGlow(false); if(!$t.textContent.trim()) setTranscript('Powiedz, co chcesz zam√≥wiƒá‚Ä¶'); parseAndSummarize($t.textContent); };
}
function startSTT(){ if(!recognition) initSTT(); try{ recognition && recognition.start(); }catch(_){} }
function stopSTT(){ try{ recognition && recognition.stop(); }catch(_){} }
function setTranscript(s){ $t.textContent=s; }

/* odszumianie duplikat√≥w: "pierogi pierogi pierogi" -> "pierogi"  */
function cleanTranscript(s){
  return s
    .replace(/\s+/g,' ')
    .replace(/\b(\w{2,})(?:\s+\1){1,}\b/gi,'$1'); // usu≈Ñ powt√≥rzone s≈Çowa
}

/* ===== intent parser (proste regu≈Çy) ===== */
const catLex = {
  taxi:  ['taxi','taks√≥w','przejazd','dojazd','kurs'],
  hotel: ['hotel','nocleg','pok√≥j','rezerw']
};
const places = ['Katowic','Krakow','Krak√≥w','Warszaw','Gdyn','Gda≈Ñsk','Pozna','Wroc≈Çaw','Sopot']; // demo
const foodHints = ['pizza','pierogi','burger','sushi','makaron','sa≈Çat','zupa','kebab','ramen'];

function detectCategory(text){
  const t=text.toLowerCase();
  if(catLex.taxi.some(w=>t.includes(w)))  return 'taxi';
  if(catLex.hotel.some(w=>t.includes(w))) return 'hotel';
  return 'food';
}
function extractTime(text){
  const m = text.match(/(?:na|o)\s+(\d{1,2})(?::(\d{2}))?/i);
  if(!m) return null;
  const hh = m[1].padStart(2,'0'); const mm = m[2]||'00';
  return `${hh}:${mm}`;
}
function extractPlace(text){
  for(const p of places){ const re=new RegExp(p,'i'); if(re.test(text)) return p.replace(/.$/,''); }
  // prosty fallback po przyimkach
  const m = text.match(/\b(?:do|na|w)\s+([A-Z≈Å≈ö≈ª≈πƒÜ√ì][\p{L}\-]+(?:\s+[A-Z≈Å≈ö≈ª≈πƒÜ√ì][\p{L}\-]+)*)/u);
  return m? m[1] : null;
}
function extractFood(text){
  const t=text.toLowerCase();
  for(const f of foodHints) if(t.includes(f)) return f;
  // fallback ‚Äì pierwsze 2-3 s≈Çowa bez przyimk√≥w
  const stop = ['na','do','w','o','i','oraz','dla','poproszƒô','proszƒô'];
  const words = t.split(/\s+/).filter(w=>!stop.includes(w) && w.length>2);
  return words.slice(0,3).join(' ') || null;
}

function parseAndSummarize(text){
  if(!text || text.length<2) return;
  const cat = detectCategory(text);
  const time = extractTime(text);
  const place = extractPlace(text);
  const dish = (cat==='food')? extractFood(text) : null;

  blinkTile(cat);
  svgBlinkCategory(cat);

  const items=[];
  items.push({icon:'‚úÖ',text:'Status: gotowe'});
  if(cat==='food'){
    items.push({icon:'üçΩÔ∏è',text:`Danie: ${dish||'‚Äî'}`});
    if(time)  items.push({icon:'‚è±',text:`Czas: ${time}`});
    if(place) items.push({icon:'üìç',text:`Miejsce: ${place}`});
    items.push({icon:'üí≤',text:'Cena: demo'});
  }else if(cat==='taxi'){
    if(place) items.push({icon:'üìç',text:`Kierunek: ${place}`});
    if(time)  items.push({icon:'‚è±',text:`Godzina: ${time}`});
    items.push({icon:'üöï',text:'Taxi zam√≥wione (demo)'});
  }else{
    if(place) items.push({icon:'üìç',text:`Miasto: ${place}`});
    if(time)  items.push({icon:'‚è±',text:`Godzina: ${time}`});
    items.push({icon:'üè®',text:'Hotel ‚Äì rezerwacja demo'});
  }
  showSummary(items);
}

/* ===== podsumowanie + TTS ===== */
function showSummary(items){
  $sumList.innerHTML='';
  items.forEach(i=>{ const li=document.createElement('li'); li.innerHTML=`${i.icon} ${i.text}`; $sumList.appendChild(li); });
  $sumBox.style.display='block';
  speak('Podsumowanie. ' + items.map(i=>i.text).join('. ') + '.');
}
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text); u.lang='pl-PL';
    const use=()=>{ const v=speechSynthesis.getVoices().find(v=>v.lang?.toLowerCase().startsWith('pl')); if(v) u.voice=v; speechSynthesis.speak(u); };
    if(speechSynthesis.getVoices().length) use(); else speechSynthesis.onvoiceschanged=use;
  }catch(e){console.warn(e)}
}

/* ===== UI: miganie kafelka + SVG ===== */
function blinkTile(cat){
  Object.values(tiles).forEach(el=>el.classList.remove('blink','active'));
  const el = tiles[cat]; if(!el) return;
  el.classList.add('active','blink');
  setTimeout(()=>el.classList.remove('blink'), 5000);
}
function addMicGlow(on){
  if(svgMic){
    if(on){ svgMic.classList.add('svg-glow'); }
    else  { svgMic.classList.remove('svg-glow'); }
  }
}
function svgBlinkCategory(cat){
  const map={food:svgFood,taxi:svgTaxi,hotel:svgHotel};
  const node = map[cat]; if(!node) return;
  node.classList.add('svg-blink');
  setTimeout(()=>node.classList.remove('svg-blink'), 3000);
}

/* ===== klik w logo: start/stop ===== */
logoObj.addEventListener('click', ()=>{
  if(!sttSupported()){ $hint.style.display='block'; addMicGlow(!isListening); return; }
  if(isListening) stopSTT(); else startSTT();
});

/* ===== kafelki ‚Äì manualne demo ===== */
tiles.food.onclick  = ()=>parseAndSummarize('zam√≥w jedzenie pizza na 19:00 do Katowic');
tiles.taxi.onclick  = ()=>parseAndSummarize('taxi do Warszawy na 18:30');
tiles.hotel.onclick = ()=>parseAndSummarize('hotel w Krakowie na 20');

/* init */
if(!sttSupported()) $hint.style.display='block';
</script>
</body>
</html>
